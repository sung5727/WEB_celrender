<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>출근캘린더(2025-08-28 제작)</title>
<style>
  :root{ --primary:#16a34a; --red:#e11d48; --blue:#2563eb; --text:#222; --sub:#6b7280; --border:#e5e7eb; --bg:#f8fafc; --card:#fff; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Apple SD Gothic Neo','Noto Sans KR',sans-serif;color:var(--text)}
  .wrap{max-width:740px;margin:0 auto;padding:12px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 4px 10px rgba(0,0,0,.04);overflow:hidden}

  .topbar{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border);gap:8px}
  .title{font-weight:700;font-size:20px;display:flex;align-items:center;gap:8px}
  .actions{display:flex;gap:8px}

  /* 버튼 (예전 디자인) */
  button{height:40px;border-radius:10px;border:1px solid var(--border);background:#fff;padding:0 14px;font-weight:600;cursor:pointer}
  .primary{background:var(--primary);border-color:var(--primary);color:#fff}
  .danger{background:#ef4444;border-color:#ef4444;color:#fff}
  .mini{height:36px;padding:0 12px;border-radius:9px;border:1px solid var(--border);background:#fff;font-weight:600;font-size:13px;cursor:pointer}
  .navbtn{width:36px;height:36px;border-radius:999px;border:1px solid var(--border);background:#fff;display:flex;align-items:center;justify-content:center;font-size:18px;line-height:1;cursor:pointer}

  .weekday{display:grid;grid-template-columns:repeat(7,1fr);background:#f3f4f6;border-bottom:1px solid var(--border)}
  .weekday div{padding:10px 0;text-align:center;font-weight:600;color:var(--sub)}
  .weekday div:first-child{color:var(--red)}
  .weekday div:last-child{color:var(--blue)}
  .grid{display:grid;grid-template-columns:repeat(7,1fr);}
  .cell{height:72px;padding:6px 8px;border-right:1px solid var(--border);border-bottom:1px solid var(--border);position:relative;background:#fff}
  .grid .cell:nth-child(7n){border-right:none}
  .date{font-weight:700}
  .sun{color:var(--red)} .sat{color:var(--blue)}
  .muted{color:#c7cdd7}
  .today .date{display: flex; align-items: center; justify-content: center; width: 33px; height: 20px; border-radius: 6px; background: #323232; color: #fff; }
  /*inline-block; width: 28px; height: 28px; line-height: 28px; text-aligh: center; border-radius: 6px; background: #000; color: #fff; font-weight: 700; }*/
  /*{outline:2px solid #9ca3af; outline-offset:-2px; border-radius:8px;} */

  .holiday-badge{ position:absolute;left:6px;top:24px;font-size:10px;color:var(--red);font-weight:700;white-space:nowrap }

  .time{ position:absolute;bottom:0;left:0;width:100%;height:22px;line-height:22px;text-align:center;font-size:13px;font-weight:600;border-radius:0; }
  .time.sevenEight{ background:#d1d5db; color:#000; } /* 7/8시 */
  .time.noon{ background:#FFCA9B; color:#000; }       /* 12시 */
  .time.off{ background:#d1fae5; color:#16a34a; }   /* 휴무 */
  .time.special{ background:#3c3c3c   ; color:#fff; }     /* 연차/병가/공가/출장/돌봄 */
  .time.special_small{ font-size:12px; background:#3c3c3c   ; color:#fff; } /* 사가독서/체련대회 폰트크기 작게*/

  /* === ⛅ 추가: 날짜-시간 사이 날씨 영역 === */
  .weather-icon{
    position:absolute;
    left:50%;
    transform:translateX(-50%);
    top:30px;           /* 날짜 아래 */
    width:20px;
    height:20px;
    pointer-events:none;
  }
  .weather-temp{
    position:absolute;
    left:0; right:0;
    top:48px;           /* 아이콘 아래 */
    text-align:center;
    font-size:10px;
    line-height:12px;
    color:#374151;
    pointer-events:none;
    white-space:nowrap;
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="topbar">
        <button class="navbtn" id="prevBtn" aria-label="이전 달">◀</button>
        <div class="title"><span id="monthTitle">YYYY. MM.</span></div>
        <div class="actions">
          <button class="mini" id="sheetLoadBtn">불러오기</button>
          <button class="navbtn" id="nextBtn" aria-label="다음 달">▶</button>
        </div>
      </div>
      <div class="weekday">
        <div>일</div><div>월</div><div>화</div><div>수</div><div>목</div><div>금</div><div>토</div>
      </div>
      <div class="grid" id="grid"></div>
    </div>
  </div>

  <!-- 모달 -->
  <div id="modal" aria-modal="true" role="dialog">
    <div class="sheet">
      <h3 id="modalDate">YYYY-MM-DD 출근/상태</h3>
      <select id="timeSelect">
        <option value="">선택</option>
        <option value="7시">7시</option>
        <option value="8시">8시</option>
        <option value="12시">12시</option>
        <option value="휴무">휴무</option>
        <option value="연차">연차</option>
        <option value="병가">병가</option>
        <option value="공가">공가</option>
        <option value="출장">출장</option>
        <option value="돌봄">돌봄</option>
        <option value="사가독서">사가독서</option>
        <option value="체련대회">체련대회</option>
      </select>
      <div class="controls">
        <button class="primary" id="saveBtn">  저장  </button>
        <button class="danger" id="clearBtn">  삭제  </button>
        <button calss id="cancelBtn">  취소  </button>
      </div>
    </div>
  </div>

<script>
  /* ========= 설정 ========= */
  const WEBAPP_URL  = 'https://script.google.com/macros/s/AKfycbwA1CtxLfbziu52wTUa-R4TKrN4NQajVtFKDVwYBFhGalUPU3QcHbK24mueAMkI8DLM/exec'; // e.g. https://script.google.com/macros/s/XXX/exec
  const SERVICE_KEY = 'f3fe3ff25a8fe96c692eacced03e726ebf3443ee7cdd8e50a1d06a1b0d7ee8cf'; // 공휴일 API 키 (있으면 입력, 없으면 공휴일 비활성)
  const USE_HOLIDAYS = SERVICE_KEY && SERVICE_KEY.trim().length > 0;
  const SERVICE_KEY_PARAM = (SERVICE_KEY||'').includes('%') ? SERVICE_KEY : encodeURIComponent(SERVICE_KEY);
  const HOLIDAY_TTL_DAYS = 7;

  const grid=document.getElementById('grid');
  const monthTitle=document.getElementById('monthTitle');
  const prevBtn=document.getElementById('prevBtn');
  const nextBtn=document.getElementById('nextBtn');
  const sheetLoadBtn=document.getElementById('sheetLoadBtn');
  const modal=document.getElementById('modal');
  const modalDate=document.getElementById('modalDate');
  const timeSelect=document.getElementById('timeSelect');
  const saveBtn=document.getElementById('saveBtn');
  const clearBtn=document.getElementById('clearBtn');
  const cancelBtn=document.getElementById('cancelBtn');

  let state=(()=>{const now=new Date();return{year:now.getFullYear(),month:now.getMonth()};})();
  let selectedKey=null;
  let sheetData={};

  const pad=n=>n.toString().padStart(2,'0');
  const keyOf=(y,m,d)=>`${y}-${pad(m+1)}-${pad(d)}`;

  /* ========= 공휴일 (월 단위 캐시/호출) ========= */
  function holidayCacheKey(year, month){ return `holidays_${year}-${pad(month+1)}_v1`; }
  function isCacheFresh(ts){ return ts && (Date.now() - ts) <= HOLIDAY_TTL_DAYS*86400000; }

  async function fetchHolidaysByMonth(year,month){
    if(!USE_HOLIDAYS) return {};
    try{
      const solMonth=pad(month+1);
      const url=`https://apis.data.go.kr/B090041/openapi/service/SpcdeInfoService/getRestDeInfo?solYear=${year}&solMonth=${solMonth}&numOfRows=100&_type=json&ServiceKey=${SERVICE_KEY_PARAM}`;
      const res=await fetch(url);
      const txt=await res.text();
      if(!res.ok){console.warn('[HolidayAPI]',res.status,txt);return {};}
      let data; try{data=JSON.parse(txt);}catch(e){return {};}
      const items=(((data||{}).response||{}).body||{}).items;
      const arr=items&&items.item?(Array.isArray(items.item)?items.item:[items.item]):[];
      const m={};
      for(const it of arr){
        const ymd=String(it.locdate||'');
        if(/^\d{8}$/.test(ymd)){
          const k=`${ymd.slice(0,4)}-${ymd.slice(4,6)}-${ymd.slice(6,8)}`;
          m[k]=it.dateName||'';
        }
      }
      return m;
    }catch(e){return {};}
  }

  let holidayMap={}; let holidayYear=null; let holidayMonth=null;

  async function ensureHolidayForMonth(year, month){
    if(!USE_HOLIDAYS){ holidayMap={}; holidayYear=year; holidayMonth=month; return; }
    const k = holidayCacheKey(year, month);
    const cached = localStorage.getItem(k);
    if (cached){
      try{
        const obj = JSON.parse(cached);
        if (obj && isCacheFresh(obj.ts)){
          holidayMap = obj.data || {};
          holidayYear = year; holidayMonth = month;
          return;
        }
      }catch{}
    }
    const data = await fetchHolidaysByMonth(year, month);
    localStorage.setItem(k, JSON.stringify({ data, ts: Date.now() }));
    holidayMap = data;
    holidayYear = year; holidayMonth = month;
  }

  /* ========= 시트 연동 ========= */
  async function reloadFromSheet(){
    const res=await fetch(WEBAPP_URL+'?_='+Date.now());
    const j=await res.json();
    if(!j||!j.ok) throw new Error(j&&j.error?j.error:('HTTP '+res.status));
    sheetData=j.data||{};
  }
  async function saveToSheet(key,value){
    const payload=new URLSearchParams();
    payload.set('payload',JSON.stringify({mode:'set',key,value}));
    const res=await fetch(WEBAPP_URL,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:payload.toString()});
    const j=await res.json();if(!j||!j.ok)throw new Error(j.error||'저장실패');
  }
  async function deleteFromSheet(key){
    const payload=new URLSearchParams();
    payload.set('payload',JSON.stringify({mode:'delete',key}));
    const res=await fetch(WEBAPP_URL,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:payload.toString()});
    const j=await res.json();if(!j||!j.ok)throw new Error(j.error||'삭제실패');
  }

  /* === ⛅ 추가: 날씨 (Open-Meteo) === */
  let geo = { lat: 37.5665, lon: 126.9780, ready:false }; // 기본: 서울
  let monthWeather = {};     // {'YYYY-MM-DD': {code, tmax, tmin}}
  let weatherFetchedFor = ''; // 'YYYY-MM'
  let currentTemp = null;    // {key:'YYYY-MM-DD', temp: number}
  const WEATHER_TZ = 'Asia/Tokyo';

  // 간단 아이콘 (data URI)
  function weatherIconDataUri(code){
    const sun   = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"><circle cx="10" cy="10" r="5" fill="%23FFC107"/></svg>';
    const cloud = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"><ellipse cx="10" cy="12" rx="8" ry="5" fill="%23B0BEC5"/></svg>';
    const rain  = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"><ellipse cx="10" cy="9" rx="8" ry="5" fill="%23B0BEC5"/><path d="M6 14 l-1 3 M10 14 l-1 3 M14 14 l-1 3" stroke="%2300A2FF" stroke-width="2"/></svg>';
    const snow  = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"><ellipse cx="10" cy="9" rx="8" ry="5" fill="%23B0BEC5"/><text x="10" y="16" text-anchor="middle" font-size="10" fill="%23ffffff">*</text></svg>';
    const storm = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"><ellipse cx="10" cy="9" rx="8" ry="5" fill="%23B0BEC5"/><polygon points="9,12 6,18 11,15 10,20 14,13" fill="%23FFC107"/></svg>';
    if ([0].includes(code)) return sun;
    if ([1,2,3,45,48].includes(code)) return cloud;
    if ([51,53,55,61,63,65,80,81,82].includes(code)) return rain;
    if ([71,73,75,77,85,86].includes(code)) return snow;
    if ([95,96,99].includes(code)) return storm;
    return cloud;
  }

  function yymm(y,m){ return `${y}-${pad(m+1)}`; }
  function todayKey(){
    const t = new Date();
    return `${t.getFullYear()}-${pad(t.getMonth()+1)}-${pad(t.getDate())}`;
  }

  async function ensureMonthWeather(y,m){
    const ym = yymm(y,m);
    if (weatherFetchedFor === ym) return;

    const start = `${y}-${pad(m+1)}-01`;
    const end   = `${y}-${pad(m+1)}-${pad(new Date(y,m+1,0).getDate())}`;

    const url = `https://api.open-meteo.com/v1/forecast?latitude=${geo.lat}&longitude=${geo.lon}` +
                `&timezone=${encodeURIComponent(WEATHER_TZ)}` +
                `&daily=weathercode,temperature_2m_max,temperature_2m_min` +
                `&current_weather=true` +
                `&start_date=${start}&end_date=${end}`;
    try{
      const res = await fetch(url);
      const j = await res.json();
      const days  = j?.daily?.time || [];
      const codes = j?.daily?.weathercode || [];
      const tmax  = j?.daily?.temperature_2m_max || [];
      const tmin  = j?.daily?.temperature_2m_min || [];
      const map = {};
      for (let i=0;i<days.length;i++){
        map[days[i]] = { code: codes[i], tmax: Math.round(tmax[i]), tmin: Math.round(tmin[i]) };
      }
      monthWeather = map;
      weatherFetchedFor = ym;

      if (j?.current_weather?.temperature != null) {
        currentTemp = { key: todayKey(), temp: Math.round(j.current_weather.temperature) };
      } else {
        currentTemp = null;
      }
    }catch(e){
      console.warn('weather fetch fail', e);
      monthWeather = {};
      currentTemp = null;
      weatherFetchedFor = ym; // 실패 플래그(무한 재시도 방지)
    }
  }

  // 최초 1회: 위치 권한 시 현재 좌표 사용(거부해도 기본값으로 진행)
  (function initGeolocationOnce(){
    if (!('geolocation' in navigator)) return;
    navigator.geolocation.getCurrentPosition(
      (pos)=>{ geo = { lat: pos.coords.latitude, lon: pos.coords.longitude, ready:true }; /* 다음 render 때 반영 */ },
      ()=>{}, // 무시
      { maximumAge: 3600_000, timeout: 5000, enableHighAccuracy: false }
    );
  })();

  /* ========= 렌더 ========= */
  function drawCalendar(){
    const y=state.year,m=state.month;
    monthTitle.textContent=`${y}. ${pad(m+1)}.`;
    const first=new Date(y,m,1);
    const lastDate=new Date(y,m+1,0).getDate();
    const startDay=first.getDay();
    const totalCells=Math.ceil((startDay+lastDate)/7)*7;
    grid.innerHTML='';
    const today=new Date();

    for(let i=0;i<totalCells;i++){
      const cell=document.createElement('div');cell.className='cell';
      const dayIndex=i-startDay+1;
      if(dayIndex<1||dayIndex>lastDate){cell.classList.add('muted');cell.innerHTML='&nbsp;';}
      else{
        const dow=i%7;if(dow===0)cell.classList.add('sun');if(dow===6)cell.classList.add('sat');
        const dateEl=document.createElement('div');dateEl.className='date';dateEl.textContent=dayIndex;cell.appendChild(dateEl);
        const k=keyOf(y,m,dayIndex);const val=sheetData[k];

        // 공휴일 배지
        if(holidayMap && holidayMap[k]){
          const b=document.createElement('div');b.className='holiday-badge';b.textContent=holidayMap[k];cell.appendChild(b);cell.classList.add('sun');
        }

        /* ⛅ 추가: 날씨 아이콘 + 기온 (최고/최저, 오늘은 현재기온도) */
        const w = monthWeather[k];
        if (w && typeof w.code === 'number') {
          const img = document.createElement('img');
          img.className = 'weather-icon';
          img.alt = '날씨';
          img.src = weatherIconDataUri(w.code);
          cell.appendChild(img);

          const temp = document.createElement('div');
          temp.className = 'weather-temp';
          let text = `${w.tmax}°/${w.tmin}°`;
          if (currentTemp && currentTemp.key === k) {
            text = `${w.tmax}°/${w.tmin}° · ${currentTemp.temp}°`;
          }
          temp.textContent = text;
          cell.appendChild(temp);
        }

        // 출근/상태 표시
        if(val){
          const t=document.createElement('div');t.className='time';t.textContent=val;
          if(val==='7시'||val==='8시')t.classList.add('sevenEight');
          else if(val==='12시')t.classList.add('noon');
          else if(val==='휴무')t.classList.add('off');
          else if(['연차','병가','공가','출장','돌봄'].includes(val)) t.classList.add('special');
          else if(['사가독서','체련대회'].includes(val)) t.classList.add('special_small');
          cell.appendChild(t);
        }

        if(today.getFullYear()===y&&today.getMonth()===m&&today.getDate()===dayIndex){cell.classList.add('today');}
        cell.addEventListener('click',()=>openModal(k,val||''));
      }
      grid.appendChild(cell);
    }
  }

  async function render(){
    const y=state.year, m=state.month;
    drawCalendar();
    if(holidayYear!==y || holidayMonth!==m){
      (async()=>{ await ensureHolidayForMonth(y,m); if(state.year===y && state.month===m) drawCalendar(); })();
    }
    await ensureMonthWeather(y,m); // ⛅ 추가: 보이는 달의 날씨 확보
    if(state.year===y && state.month===m) drawCalendar(); // 날씨 반영 재렌더
  }

  /* ========= 모달 ========= */
  function openModal(key,value){selectedKey=key;modalDate.textContent=key+' 출근/상태';timeSelect.value=value||'';modal.style.display='flex';}
  function closeModal(){modal.style.display='none';}

  // 낙관적 업데이트
  saveBtn.addEventListener('click',async()=>{
    if(!selectedKey) return;
    try{
      const v = timeSelect.value || '';
      await saveToSheet(selectedKey, v);
      sheetData[selectedKey] = v;
      drawCalendar();
      closeModal();
    }catch(e){ alert('저장 실패: '+e.message); }
  });

  clearBtn.addEventListener('click',async()=>{
    if(!selectedKey) return;
    try{
      await deleteFromSheet(selectedKey);
      delete sheetData[selectedKey];
      drawCalendar();
      closeModal();
    }catch(e){ alert('삭제 실패: '+e.message); }
  });

  cancelBtn.addEventListener('click',closeModal);
  modal.addEventListener('click',e=>{if(e.target===modal)closeModal();});

  /* ========= 월 네비 ========= */
  prevBtn.addEventListener('click',()=>{state.month--;if(state.month<0){state.month=11;state.year--;}render();});
  nextBtn.addEventListener('click',()=>{state.month++;if(state.month>11){state.month=0;state.year++;}render();});
  sheetLoadBtn.addEventListener('click',async()=>{try{await reloadFromSheet();drawCalendar();alert('불러오기 성공');}catch(e){alert('불러오기 실패:'+e.message);}});

  (async()=>{try{await reloadFromSheet();}catch{}render();})();

  // 스와이프 제스처
  let touchStartX = 0, touchEndX = 0;
  grid.addEventListener('touchstart',(e)=>{touchStartX=e.changedTouches[0].screenX;},false);
  grid.addEventListener('touchend',(e)=>{touchEndX=e.changedTouches[0].screenX;handleSwipe();},false);
  function handleSwipe(){
    const diff = touchEndX - touchStartX;
    if (Math.abs(diff) > 50){
      if (diff > 0){ state.month--; if(state.month<0){state.month=11;state.year--;} render(); }
      else { state.month++; if(state.month>11){state.month=0;state.year++;} render(); }
    }
  }
</script>
</body>
</html>
