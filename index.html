<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>출근캘린더(2025-08-28 제작)</title>
<style>
  :root{ --primary:#16a34a; --red:#e11d48; --blue:#2563eb; --text:#222; --sub:#6b7280; --border:#e5e7eb; --bg:#f8fafc; --card:#fff; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Apple SD Gothic Neo','Noto Sans KR',sans-serif;color:var(--text)}
  .wrap{max-width:740px;margin:0 auto;padding:12px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 4px 10px rgba(0,0,0,.04);overflow:hidden}

  .topbar{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border);gap:8px}
  .title{font-weight:700;font-size:20px;display:flex;align-items:center;gap:8px}
  .actions{display:flex;gap:8px}

  button{height:40px;border-radius:10px;border:1px solid var(--border);background:#fff;padding:0 14px;font-weight:600;cursor:pointer}
  .primary{background:var(--primary);border-color:var(--primary);color:#fff}
  .danger{background:#ef4444;border-color:#ef4444;color:#fff}
  .mini{height:36px;padding:0 12px;border-radius:9px;border:1px solid var(--border);background:#fff;font-weight:600;font-size:13px;cursor:pointer}
  .navbtn{width:36px;height:36px;border-radius:999px;border:1px solid var(--border);background:#fff;display:flex;align-items:center;justify-content:center;font-size:18px;line-height:1;cursor:pointer}

  .weekday{display:grid;grid-template-columns:repeat(7,1fr);background:#f3f4f6;border-bottom:1px solid var(--border)}
  .weekday div{padding:10px 0;text-align:center;font-weight:600;color:var(--sub)}
  .weekday div:first-child{color:var(--red)}
  .weekday div:last-child{color:var(--blue)}
  .grid{display:grid;grid-template-columns:repeat(7,1fr);}
  .cell{height:72px;padding:6px 8px;border-right:1px solid var(--border);border-bottom:1px solid var(--border);position:relative;background:#fff}
  .grid .cell:nth-child(7n){border-right:none}
  .date{font-weight:700}
  .sun .date{color:var(--red)}
  .sat .date{color:var(--blue)}
  .muted{color:#c7cdd7}

  /* 엣지(앞/뒤 달) 흐리게 */
  .edge .date{ color:#c7cdd7; }
  .edge .time{ opacity:.55; }
  .edge.sun .date { color:rgba(225,29,72,0.5); }   /* 일요일 엣지 → 흐린 빨강 */
  .edge.sat .date { color:rgba(37,99,235,0.5); }   /* 토요일 엣지 → 흐린 파랑 */
  .edge.holiday .date { color:rgba(225,29,72,0.5); } /* 공휴일 엣지 → 흐린 빨강 */
  .edge .holiday-badge { opacity:.5; }

  /* 오늘 날짜 배경 */
  .cell .today { background:#f9fafb; }
  
  /* 오늘 날짜 스타일 */
  .today .date{
    display:flex;align-items:center;justify-content:center;
    width:33px;height:20px;border-radius:6px;
    background:#323232;color:#fff;
    border:2px solid transparent;
  }
  .today.sun .date{ border-color: var(--red); }
  .today.sat .date{ border-color: var(--blue); }

  /* 공휴일 이름 */
  .holiday-badge{
    position:absolute;left:6px;top:24px;font-size:10px;color:var(--red);font-weight:700;white-space:nowrap
  }

  /* 출근/상태 바 */
  .time{
    position:absolute;bottom:0;left:0;width:100%;height:22px;line-height:22px;
    text-align:center;font-size:13px;font-weight:600;border-radius:0;
  }
  .time.sevenEight{ background:#E5E5E5; color:#000; }
  .time.noon{ background:#FFB703; color:#000; }
  .time.off{ background:#8ECAE6; color:#000; }
  .time.special{ background:#8ECAE6; color:#000; }
  .time.special_small{ font-size:12px; background:#219EBC; color:#000; }

  /* 모달 */
  #modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:50;align-items:flex-end}
  #modal.show{display:flex;}
  .sheet{width:100%;max-width:740px;margin:0 auto;background:#fff;border-top-left-radius:16px;border-top-right-radius:16px;padding:16px;box-shadow:0 -6px 20px rgba(0,0,0,.15)}
  .sheet h3{margin:0 0 10px 0;font-size:16px}
  .controls{display:flex;gap:8px;margin-top:12px}
  select{width:100%;height:44px;border:1px solid var(--border);border-radius:10px;padding:0 10px;font-size:16px;background:#fff}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="topbar">
        <button class="navbtn" id="prevBtn">◀</button>
        <div class="title"><span id="monthTitle">YYYY. MM.</span></div>
        <div class="actions">
          <button class="mini" id="sheetLoadBtn">불러오기</button>
          <button class="navbtn" id="nextBtn">▶</button>
        </div>
      </div>
      <div class="weekday">
        <div>일</div><div>월</div><div>화</div><div>수</div><div>목</div><div>금</div><div>토</div>
      </div>
      <div class="grid" id="grid"></div>
    </div>
  </div>

  <!-- 모달 -->
  <div id="modal">
    <div class="sheet">
      <h3 id="modalDate">YYYY-MM-DD 출근/상태</h3>
      <select id="timeSelect">
        <option value="">선택</option>
        <option value="7시">7시</option>
        <option value="8시">8시</option>
        <option value="12시">12시</option>
        <option value="휴무">휴무</option>
        <option value="연차">연차</option>
        <option value="병가">병가</option>
        <option value="공가">공가</option>
        <option value="출장">출장</option>
        <option value="돌봄">돌봄</option>
        <option value="사가독서">사가독서</option>
        <option value="체련대회">체련대회</option>
      </select>
      <div class="controls">
        <button class="primary" id="saveBtn">저장</button>
        <button class="danger" id="clearBtn">삭제</button>
        <button id="cancelBtn">취소</button>
      </div>
    </div>
  </div>

<script>
  const WEBAPP_URL  = 'https://script.google.com/macros/s/AKfycbwA1CtxLfbziu52wTUa-R4TKrN4NQajVtFKDVwYBFhGalUPU3QcHbK24mueAMkI8DLM/exec';
  const SERVICE_KEY = 'f3fe3ff25a8fe96c692eacced03e726ebf3443ee7cdd8e50a1d06a1b0d7ee8cf'; // 공휴일 API 키 입력
  const USE_HOLIDAYS = SERVICE_KEY && SERVICE_KEY.trim().length > 0;
  const SERVICE_KEY_PARAM = encodeURIComponent(SERVICE_KEY);

  const grid=document.getElementById('grid');
  const monthTitle=document.getElementById('monthTitle');
  const prevBtn=document.getElementById('prevBtn');
  const nextBtn=document.getElementById('nextBtn');
  const sheetLoadBtn=document.getElementById('sheetLoadBtn');
  const modal=document.getElementById('modal');
  const modalDate=document.getElementById('modalDate');
  const timeSelect=document.getElementById('timeSelect');
  const saveBtn=document.getElementById('saveBtn');
  const clearBtn=document.getElementById('clearBtn');
  const cancelBtn=document.getElementById('cancelBtn');

  // 마지막 본 달 유지
  let state=(()=>{try{const s=localStorage.getItem('lastView');if(s){const o=JSON.parse(s);if(o.year&&o.month>=0)return o;}}catch(e){};const n=new Date();return{year:n.getFullYear(),month:n.getMonth()};})();
  let selectedKey=null; let sheetData={};
  let holidayMap={};
  const pad=n=>n.toString().padStart(2,'0');
  const keyOf=(y,m,d)=>`${y}-${pad(m+1)}-${pad(d)}`;

  // (보조) month 오프셋 계산
  function ymAdd(year, month, delta){
    const d = new Date(year, month + delta, 1);
    return { y: d.getFullYear(), m: d.getMonth() };
  }

  /* 공휴일 (특정 월) */
  async function fetchHolidays(year,month){
    if(!USE_HOLIDAYS) return {};
    const url=`https://apis.data.go.kr/B090041/openapi/service/SpcdeInfoService/getRestDeInfo?solYear=${year}&solMonth=${pad(month+1)}&numOfRows=100&_type=json&ServiceKey=${SERVICE_KEY_PARAM}`;
    const res=await fetch(url); if(!res.ok) return {};
    const data=await res.json();
    const items=(((data||{}).response||{}).body||{}).items;
    const arr=items&&items.item?(Array.isArray(items.item)?items.item:[items.item]):[];
    const map={};
    for(const it of arr){
      const ymd=String(it.locdate||'');
      if(/^\d{8}$/.test(ymd)){
        const k=`${ymd.slice(0,4)}-${ymd.slice(4,6)}-${ymd.slice(6,8)}`;
        map[k]=it.dateName||'';
      }
    }
    return map;
  }

  /* 시트 연동 */
  async function reloadFromSheet(){
    const res=await fetch(WEBAPP_URL+'?_='+Date.now());const j=await res.json();
    if(j&&j.ok) sheetData=j.data||{};
  }
  async function saveToSheet(key,value){
    const p=new URLSearchParams();p.set('payload',JSON.stringify({mode:'set',key,value}));
    await fetch(WEBAPP_URL,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:p.toString()});
  }
  async function deleteFromSheet(key){
    const p=new URLSearchParams();p.set('payload',JSON.stringify({mode:'delete',key}));
    await fetch(WEBAPP_URL,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:p.toString()});
  }

  /* 캘린더 렌더 (이전/다음달 흐리게 포함) */
  function drawCalendar(){
    const y=state.year,m=state.month;
    monthTitle.textContent=`${y}. ${pad(m+1)}.`;

    const firstDay=new Date(y,m,1).getDay();
    const lastDate=new Date(y,m+1,0).getDate();
    const prevLast=new Date(y,m,0).getDate();
    const totalCells=Math.ceil((firstDay+lastDate)/7)*7;

    grid.innerHTML='';
    const today=new Date();

    for(let i=0;i<totalCells;i++){
      const cell=document.createElement('div');cell.className='cell';

      let dNum, cYear, cMonth, isEdge=false;
      if(i < firstDay){
        dNum = prevLast - firstDay + i + 1;
        cYear = (m===0 ? y-1 : y);
        cMonth = (m===0 ? 11 : m-1);
        isEdge = true;
      } else if (i >= firstDay + lastDate) {
        dNum = i - (firstDay + lastDate) + 1;
        cYear = (m===11 ? y+1 : y);
        cMonth = (m===11 ? 0 : m+1);
        isEdge = true;
      } else {
        dNum = i - firstDay + 1;
        cYear = y; cMonth = m;
      }

      const dow = i % 7; // 0=일,6=토
      if(dow===0) cell.classList.add('sun');
      if(dow===6) cell.classList.add('sat');

      const dateEl=document.createElement('div');
      dateEl.className='date';
      dateEl.textContent=dNum;
      if(isEdge) cell.classList.add('edge');
      cell.appendChild(dateEl);

      const k=keyOf(cYear,cMonth,dNum);

      // 공휴일 이름/색상
      if(holidayMap[k]){
        const b=document.createElement('div'); b.className='holiday-badge'; b.textContent=holidayMap[k];
        cell.appendChild(b);
        cell.classList.add('holiday');
        if(!isEdge) cell.classList.add('sun'); // 이번달 공휴일은 빨강
        else cell.classList.add('edge','holiday'); // 엣지는 흐린 빨강 (CSS)
      }

      // 시트 값
      const val=sheetData[k];
      if(val){
        const t=document.createElement('div'); t.className='time'; t.textContent=val;
        if(val==='7시'||val==='8시') t.classList.add('sevenEight');
        else if(val==='12시')        t.classList.add('noon');
        else if(val==='휴무')        t.classList.add('off');
        else if(['연차','병가','공가','출장','돌봄'].includes(val)) t.classList.add('special');
        else if(['사가독서','체련대회'].includes(val))             t.classList.add('special_small');
        if(isEdge) t.style.opacity = .55;
        cell.appendChild(t);
      }

      // 오늘은 이번달일 때만
      if(!isEdge && today.getFullYear()===cYear && today.getMonth()===cMonth && today.getDate()===dNum){
        cell.classList.add('today');
        if(dow===0) cell.classList.add('sun');
        if(dow===6) cell.classList.add('sat');
      }

      // 입력
      cell.addEventListener('click',()=>openModal(k,val||''));
      grid.appendChild(cell);
    }
  }

  /* 렌더: 현재달 + 이전달 + 다음달 공휴일을 합쳐서 적용 */
  function render(){
    drawCalendar();
    localStorage.setItem('lastView', JSON.stringify(state));

    (async ()=>{
      try{
        const { y:py, m:pm } = ymAdd(state.year, state.month, -1);
        const { y:ny, m:nm } = ymAdd(state.year, state.month,  1);
        const [prevMap, currMap, nextMap] = await Promise.all([
          fetchHolidays(py, pm),
          fetchHolidays(state.year, state.month),
          fetchHolidays(ny, nm),
        ]);
        holidayMap = Object.assign({}, prevMap, currMap, nextMap);
      }catch(e){
        holidayMap = {};
      }
      drawCalendar(); // 공휴일 반영해서 다시 그림 (엣지 포함)
    })();
  }

  /* 모달 */
  function openModal(key,value){selectedKey=key;modalDate.textContent=key+' 출근/상태';timeSelect.value=value||'';modal.classList.add('show');}
  function closeModal(){modal.classList.remove('show');}
  saveBtn.addEventListener('click',async()=>{if(!selectedKey)return;await saveToSheet(selectedKey,timeSelect.value);sheetData[selectedKey]=timeSelect.value;drawCalendar();closeModal();});
  clearBtn.addEventListener('click',async()=>{if(!selectedKey)return;await deleteFromSheet(selectedKey);delete sheetData[selectedKey];drawCalendar();closeModal();});
  cancelBtn.addEventListener('click',closeModal);
  modal.addEventListener('click',e=>{if(e.target===modal)closeModal();});

  // 버튼 네비
  prevBtn.addEventListener('click',()=>{state.month--;if(state.month<0){state.month=11;state.year--;}render();});
  nextBtn.addEventListener('click',()=>{state.month++;if(state.month>11){state.month=0;state.year++;}render();});
  sheetLoadBtn.addEventListener('click',async()=>{await reloadFromSheet();drawCalendar();alert('불러오기 성공');});

  // 스와이프
  let touchStartX=0, touchEndX=0, touchStartY=0, touchEndY=0;
  const SWIPE_THRESHOLD = 50, VERTICAL_TOLERANCE = 40;
  grid.addEventListener('touchstart', e=>{
    touchStartX = e.changedTouches[0].screenX;
    touchStartY = e.changedTouches[0].screenY;
  }, {passive:true});
  grid.addEventListener('touchend', e=>{
    touchEndX = e.changedTouches[0].screenX;
    touchEndY = e.changedTouches[0].screenY;
    const dx = touchEndX - touchStartX;
    const dy = touchEndY - touchStartY;
    if (Math.abs(dx) > SWIPE_THRESHOLD && Math.abs(dy) < VERTICAL_TOLERANCE){
      if (dx < 0){ state.month++; if(state.month>11){state.month=0;state.year++;} }
      else { state.month--; if(state.month<0){state.month=11;state.year--;} }
      render();
    }
  }, {passive:true});

  // 시작
  (async()=>{await reloadFromSheet();render();})();
</script>
</body>
</html>
