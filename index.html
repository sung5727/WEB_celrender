<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ì¶œê·¼ ì›”ê°„ ìº˜ë¦°ë” (WebApp ë™ê¸°í™” + ì—‘ì…€ ë¶ˆëŸ¬ì˜¤ê¸°/ë‚´ë³´ë‚´ê¸°)</title>
<style>
  :root{
    --primary:#16a34a; --red:#e11d48; --blue:#2563eb; --text:#222;
    --sub:#6b7280; --border:#e5e7eb; --bg:#f8fafc; --card:#ffffff;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Apple SD Gothic Neo','Noto Sans KR',sans-serif;color:var(--text)}
  .wrap{max-width:740px;margin:0 auto;padding:12px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 4px 10px rgba(0,0,0,.04);overflow:hidden}
  .topbar{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border);gap:8px}
  .navbtn{width:36px;height:36px;border-radius:999px;border:1px solid var(--border);background:#fff;display:flex;align-items:center;justify-content:center;font-size:18px;line-height:1;cursor:pointer}
  .title{font-weight:700;font-size:20px;display:flex;align-items:center;gap:8px}
  .actions{display:flex;gap:8px}
  .mini{height:36px;padding:0 12px;border-radius:9px;border:1px solid var(--border);background:#fff;font-weight:600;font-size:13px;cursor:pointer}
  .weekday{display:grid;grid-template-columns:repeat(7,1fr);background:#f3f4f6;border-bottom:1px solid var(--border)}
  .weekday div{padding:10px 0;text-align:center;font-weight:600;color:var(--sub)}
  .weekday div:first-child{color:var(--red)}
  .weekday div:last-child{color:var(--blue)}
  .grid{display:grid;grid-template-columns:repeat(7,1fr);}
  .cell{height:72px;padding:6px 8px;border-right:1px solid var(--border);border-bottom:1px solid var(--border);position:relative;background:#fff}
  .grid .cell:nth-child(7n){border-right:none}
  .date{font-weight:700}
  .sun{color:var(--red)} .sat{color:var(--blue)}
  .muted{color:#c7cdd7}
  .today{outline:2px solid var(--primary);outline-offset:-2px;border-radius:8px}

  .holiday-badge{
    position:absolute;left:6px;top:24px;font-size:10px;color:var(--red);font-weight:700;white-space:nowrap
  }

  .time{
    position:absolute;bottom:0;left:0;width:100%;
    height:22px;line-height:22px;text-align:center;font-size:12px;font-weight:600;border-radius:0;
  }
  .time.sevenEight{ background:#d1d5db; color:#000; }
  .time.noon{ background:orange; color:#000; }
  .time.off{ background:#d1fae5; color:#16a34a; }
  .time.special{ background:#000; color:#fff; }

  #apiStatus{ display:none !important; }

  #modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:50;align-items:flex-end}
  .sheet{width:100%;max-width:740px;margin:0 auto;background:#fff;border-top-left-radius:16px;border-top-right-radius:16px;padding:16px;box-shadow:0 -6px 20px rgba(0,0,0,.15)}
  .sheet h3{margin:0 0 10px 0;font-size:16px}
  .controls{display:flex;gap:8px;margin-top:12px}
  button{height:40px;border-radius:10px;border:1px solid var(--border);background:#fff;padding:0 14px;font-weight:600;cursor:pointer}
  .primary{background:var(--primary);border-color:var(--primary);color:#fff}
  .danger{background:#fff;border-color:#ef4444;color:#ef4444}
  select{width:100%;height:44px;border:1px solid var(--border);border-radius:10px;padding:0 10px;font-size:16px;background:#fff}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="topbar">
        <button class="navbtn" id="prevBtn" aria-label="ì´ì „ ë‹¬">â—€</button>
        <div class="title">
          <span id="monthTitle">YYYY. MM.</span>
          <span id="apiStatus" aria-live="polite"></span>
        </div>
        <div class="actions">
          <button class="mini" id="importBtn" title="ì—‘ì…€/CSV ë¶ˆëŸ¬ì˜¤ê¸°">ì—…ë¡œë“œ</button>
          <button class="mini" id="excelExportBtn" title="í˜„ì¬ ë‹¬ ì „ì²´ ë‚´ë³´ë‚´ê¸°">ë‚´ë³´ë‚´ê¸°</button>
          <button class="navbtn" id="nextBtn" aria-label="ë‹¤ìŒ ë‹¬">â–¶</button>
        </div>
      </div>
      <div class="weekday">
        <div>ì¼</div><div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div>í† </div>
      </div>
      <div class="grid" id="grid"></div>
    </div>
  </div>

  <div id="modal" aria-modal="true" role="dialog">
    <div class="sheet">
      <h3 id="modalDate">YYYY-MM-DD ì¶œê·¼/ìƒíƒœ</h3>
      <select id="timeSelect" aria-label="ì¶œê·¼/ìƒíƒœ ì„ íƒ">
        <option value="">ì„ íƒ</option>
        <option value="7ì‹œ">7ì‹œ</option>
        <option value="8ì‹œ">8ì‹œ</option>
        <option value="12ì‹œ">12ì‹œ</option>
        <option value="íœ´ë¬´">íœ´ë¬´</option>
        <option value="ì—°ì°¨">ì—°ì°¨</option>
        <option value="ë³‘ê°€">ë³‘ê°€</option>
        <option value="ê³µê°€">ê³µê°€</option>
        <option value="ì¶œì¥">ì¶œì¥</option>
        <option value="ëŒë´„">ëŒë´„</option>
        <option value="ì‚¬ê°€ë…ì„œ">ì‚¬ê°€ë…ì„œ</option>
      </select>
      <div class="controls">
        <button class="primary" id="saveBtn">ì €ì¥</button>
        <button class="danger" id="clearBtn">ì‚­ì œ</button>
        <button id="cancelBtn">ì·¨ì†Œ</button>
      </div>
    </div>
  </div>

  <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display:none" />
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
  /* ========= ì„¤ì • ========= */
  const SERVICE_KEY = "";  // ê³µíœ´ì¼ API (ì—†ì–´ë„ ì‘ë™)
  const USE_HOLIDAYS = !!SERVICE_KEY;
  const HOLIDAY_TTL_DAYS = 7;

  /* ========= ì—˜ë¦¬ë¨¼íŠ¸ ========= */
  const grid = document.getElementById('grid');
  const monthTitle = document.getElementById('monthTitle');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const importBtn = document.getElementById('importBtn');
  const excelExportBtn = document.getElementById('excelExportBtn');
  const fileInput = document.getElementById('fileInput');
  const modal = document.getElementById('modal');
  const modalDate = document.getElementById('modalDate');
  const timeSelect = document.getElementById('timeSelect');
  const saveBtn = document.getElementById('saveBtn');
  const cancelBtn = document.getElementById('cancelBtn');
  const clearBtn = document.getElementById('clearBtn');
  const apiStatus = document.getElementById('apiStatus');

  /* ========= ìƒíƒœ/ìœ í‹¸ ========= */
  let state = (()=>{ const now = new Date(); return { year: now.getFullYear(), month: now.getMonth() }; })();
  let selectedKey = null;
  const storeKey = 'workTimes';

  function getStore(){ try{ return JSON.parse(localStorage.getItem(storeKey) || '{}'); } catch(e){ return {}; } }
  function setStore(data){ localStorage.setItem(storeKey, JSON.stringify(data)); }
  function pad(n){ return n.toString().padStart(2,'0'); }
  function keyOf(y,m,d){ return `${y}-${pad(m+1)}-${pad(d)}`; }

  /* ========= ê³µíœ´ì¼(ì˜µì…˜) ========= */
  function holidayCacheKey(year){ return `holidays_${year}_v3`; }
  function isCacheFresh(ts){ return ts && (Date.now() - ts) <= HOLIDAY_TTL_DAYS*86400000; }
  async function fetchHolidaysByMonth(year, month) {
    try{
      const solMonth = pad(month+1);
      const url = `https://apis.data.go.kr/B090041/openapi/service/SpcdeInfoService/getRestDeInfo?`+
                  `solYear=${year}&solMonth=${solMonth}&numOfRows=100&_type=json&ServiceKey=${encodeURIComponent(SERVICE_KEY)}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error('HTTP '+res.status);
      const data = await res.json();
      const items = (((data||{}).response||{}).body||{}).items;
      const arr = items && items.item ? (Array.isArray(items.item) ? items.item : [items.item]) : [];
      const map = {};
      for (const it of arr) {
        const ymd = String(it.locdate);
        if (/^\d{8}$/.test(ymd)) {
          const key = `${ymd.slice(0,4)}-${ymd.slice(4,6)}-${ymd.slice(6,8)}`;
          map[key] = it.dateName || '';
        }
      }
      return map;
    }catch{ return {}; }
  }
  async function loadHolidaysForYear(year){
    if (!USE_HOLIDAYS) return {};
    const cacheKey = holidayCacheKey(year);
    const cached = localStorage.getItem(cacheKey);
    if (cached){
      try{ const obj = JSON.parse(cached); if (isCacheFresh(obj.ts)) return obj.data || {}; }catch{}
    }
    const all = {};
    for (let m=0; m<12; m++) Object.assign(all, await fetchHolidaysByMonth(year, m));
    localStorage.setItem(cacheKey, JSON.stringify({ data: all, ts: Date.now() }));
    return all;
  }

  /* ========= ë Œë” ========= */
  let holidayMap = {};
  let holidayYear = null;

  function drawCalendar(){
    const y = state.year, m = state.month;
    const first = new Date(y,m,1);
    const lastDate = new Date(y,m+1,0).getDate();
    const startDay = first.getDay();
    const totalCells = Math.ceil((startDay + lastDate) / 7) * 7;

    grid.innerHTML = '';
    monthTitle.textContent = `${y}. ${pad(m+1)}.`;

    const today = new Date();
    const store = getStore();

    for(let i=0;i<totalCells;i++){
      const cell=document.createElement('div');
      cell.className='cell';
      const dayIndex=i-startDay+1;

      if(dayIndex<1||dayIndex>lastDate){
        cell.classList.add('muted');
        cell.innerHTML='&nbsp;';
      }else{
        const dow=i%7;
        if(dow===0) cell.classList.add('sun');
        if(dow===6) cell.classList.add('sat');

        const dateEl=document.createElement('div');
        dateEl.className='date';
        dateEl.textContent=dayIndex;
        cell.appendChild(dateEl);

        const k=keyOf(y,m,dayIndex);
        const value=store[k];

        if (holidayMap && holidayMap[k]) {
          const badge=document.createElement('div');
          badge.className='holiday-badge';
          badge.textContent=holidayMap[k];
          cell.appendChild(badge);
          cell.classList.add('sun');
        }

        if(value){
          const t=document.createElement('div');
          t.className='time';
          t.textContent=value;
          if (value==='7ì‹œ'||value==='8ì‹œ') t.classList.add('sevenEight');
          else if (value==='12ì‹œ') t.classList.add('noon');
          else if (value==='íœ´ë¬´') t.classList.add('off');
          else if (['ì—°ì°¨','ë³‘ê°€','ê³µê°€','ì¶œì¥','ëŒë´„','ì‚¬ê°€ë…ì„œ'].includes(value)) t.classList.add('special');
          cell.appendChild(t);
        }

        if(today.getFullYear()===y && today.getMonth()===m && today.getDate()===dayIndex){
          cell.classList.add('today');
        }

        cell.addEventListener('click', ()=> openModal(k, value || ''));
      }
      grid.appendChild(cell);
    }
  }

  function render(){
    drawCalendar();
    const y = state.year;
    if (holidayYear !== y){
      holidayYear = y;
      (async ()=>{
        holidayMap = await loadHolidaysForYear(y);
        if (state.year === y) drawCalendar();
      })();
    }
  }

  /* ========= ëª¨ë‹¬ ========= */
  function openModal(key, value){
    selectedKey = key;
    modalDate.textContent = key + ' ì¶œê·¼/ìƒíƒœ';
    timeSelect.value = value || '';
    modal.style.display = 'flex';
  }
  function closeModal(){ modal.style.display = 'none'; }
  saveBtn.addEventListener('click', ()=>{
    if(!selectedKey) return;
    const store = getStore();
    store[selectedKey] = timeSelect.value || '';
    setStore(store);
    closeModal();
    drawCalendar();
  });
  clearBtn.addEventListener('click', ()=>{
    if(!selectedKey) return;
    const store = getStore();
    delete store[selectedKey];
    setStore(store);
    closeModal();
    drawCalendar();
  });
  cancelBtn.addEventListener('click', closeModal);
  modal.addEventListener('click', (e)=>{ if(e.target===modal) closeModal(); });

  /* ========= ì›” ë„¤ë¹„ ========= */
  prevBtn.addEventListener('click', ()=>{
    state.month--;
    if(state.month < 0){ state.month = 11; state.year--; }
    render();
  });
  nextBtn.addEventListener('click', ()=>{
    state.month++;
    if(state.month > 11){ state.month = 0; state.year++; }
    render();
  });

  /* ========= ì—‘ì…€ ì—…/ë‹¤ìš´ ========= */
  const ALLOWED_VALUES = ['7ì‹œ','8ì‹œ','12ì‹œ','íœ´ë¬´','ì—°ì°¨','ë³‘ê°€','ê³µê°€','ì¶œì¥','ëŒë´„','ì‚¬ê°€ë…ì„œ'];
  function isWorkTimeValue(v){ return ALLOWED_VALUES.includes(String(v).trim()); }
  function normalizeHeader(h){ return String(h||'').toLowerCase().replace(/\s+/g,'').replace(/[^\wê°€-í£]/g,''); }
  function pad2(n){ return n.toString().padStart(2,'0'); }
  function toKeyFromExcelDate(v){
    if (v == null || v === '') return null;
    if (typeof v === 'number') {
      const d = XLSX.SSF.parse_date_code(v);
      if (!d || !d.y || !d.m || !d.d) return null;
      return `${d.y}-${pad2(d.m)}-${pad2(d.d)}`;
    }
    let s = String(v).trim().replace(/[./]/g,'-').replace(/\s+/g,'');
    const m1 = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
    if (m1) return `${m1[1]}-${pad2(+m1[2])}-${pad2(+m1[3])}`;
    const dt = new Date(s);
    if (!isNaN(dt)) return `${dt.getFullYear()}-${pad2(dt.getMonth()+1)}-${pad2(dt.getDate())}`;
    return null;
  }

  importBtn.addEventListener('click', ()=> fileInput.click());
  fileInput.addEventListener('change', async (e)=>{
    const file = e.target.files && e.target.files[0];
    if (!file) return;
    try {
      const ext = (file.name.split('.').pop() || '').toLowerCase();
      let rows = [];
      if (ext === 'csv') {
        const text = await file.text();
        rows = text.split(/\r?\n/).map(r => r.split(','));
      } else {
        const data = await file.arrayBuffer();
        const wb = XLSX.read(data, { type:'array' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        rows = XLSX.utils.sheet_to_json(ws, { header:1, raw:true });
      }
      if (!rows.length) { alert('ì—‘ì…€/CSVì—ì„œ ë°ì´í„°ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.'); return; }

      const header = rows[0] || [];
      const nh = header.map(normalizeHeader);
      let idxDate = nh.findIndex(x => ['ë‚ ì§œ','ì¼ì','date'].includes(x));
      let idxTime = nh.findIndex(x => ['ì¶œê·¼ì‹œê°„','ì¶œê·¼','ê·¼ë¬´','time','ê·¼ë¬´ì‹œê°„','ìƒíƒœ'].includes(x));
      let startRow = 1;
      if (idxDate === -1 && idxTime === -1) { idxDate = 0; idxTime = 2; startRow = 0; }
      if (idxDate === -1 || idxTime === -1) {
        alert('í—¤ë”ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.\ní—¤ë”ê°€ ìˆë‹¤ë©´ "ë‚ ì§œ/ì¼ì/date", "ì¶œê·¼ì‹œê°„/ê·¼ë¬´/time/ìƒíƒœ" ì¤‘ í•˜ë‚˜ë¡œ ì‘ì„±í•´ ì£¼ì„¸ìš”.\ní—¤ë”ê°€ ì—†ë‹¤ë©´ Aì—´=ë‚ ì§œ, Cì—´=ì¶œê·¼ì‹œê°„(ìƒíƒœ)ë¡œ ë°°ì¹˜í•´ ì£¼ì„¸ìš”.');
        return;
      }

      const store = getStore();
      let applied = 0, skipped = 0;
      for (let r = startRow; r < rows.length; r++){
        const row = rows[r]; if (!row || row.length === 0) continue;
        const key = toKeyFromExcelDate(row[idxDate]); if (!key) { skipped++; continue; }
        const rawTime = (row[idxTime] ?? '').toString().trim();
        if (!isWorkTimeValue(rawTime)) { skipped++; continue; }
        store[key] = rawTime; applied++;
      }
      setStore(store); // <- ì—¬ê¸°ì„œ ìë™ í´ë¼ìš°ë“œ ì €ì¥(ì•„ë˜ ë˜í¼ê°€ ë¶™ìŒ)
      drawCalendar();
      alert(`ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ\nì ìš©: ${applied}ê±´, ê±´ë„ˆëœ€: ${skipped}ê±´`);
    } catch(err){
      console.error(err);
      alert('ì—‘ì…€ ë¶ˆëŸ¬ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. íŒŒì¼ í˜•ì‹ê³¼ ë‚´ìš©(í—¤ë”/ì—´ ìœ„ì¹˜)ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.');
    } finally { fileInput.value = ''; }
  });

  const WEEKDAY_KO = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
  excelExportBtn.addEventListener('click', ()=>{
    const y = state.year, m = state.month;
    const lastDate = new Date(y, m+1, 0).getDate();
    const store = getStore();
    const rows = [['ë‚ ì§œ','ìš”ì¼','ì¶œê·¼/ìƒíƒœ']];
    for (let d=1; d<=lastDate; d++){
      const k = keyOf(y, m, d);
      const yoil = WEEKDAY_KO[new Date(y, m, d).getDay()];
      rows.push([k, yoil, store[k] || '']);
    }
    const ws = XLSX.utils.aoa_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, `${y}-${pad(m+1)}`);
    XLSX.writeFile(wb, `workTimes_${y}-${pad(m+1)}.xlsx`);
  });

  /* ========= ì‹œì‘ ========= */
  render();

  /* ğŸ”½ ìŠ¤í”„ë ˆë“œì‹œíŠ¸(Web App) ë™ê¸°í™” ëª¨ë“ˆ */
  const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbz4_02ZL_n_YiY4ntRd2RLi2bkLHpvvZG1Pgn3M6QEe0xMo-Q9vAe7KT9hwWkGNZ4ZT/exec'; // e.g. https://script.google.com/macros/s/XXXX/exec
  let _cloudTimer = null;

  function cloudSaveDebounced(data){
    clearTimeout(_cloudTimer);
    _cloudTimer = setTimeout(()=>cloudSave(data), 600);
  }
  async function cloudSave(data){
    try{
      const payload = new URLSearchParams();
      payload.set('payload', JSON.stringify({ data }));
      await fetch(WEBAPP_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
        body: payload.toString()
      });
      // ì¡°ìš©íˆ ì„±ê³µ
    }catch(e){
      console.warn('cloudSave error', e);
    }
  }
  async function cloudLoad(){
    try{
      const res = await fetch(WEBAPP_URL + '?_=' + Date.now());
      const j = await res.json();
      if (j && j.ok && j.data) {
        localStorage.setItem(storeKey, JSON.stringify(j.data));
        drawCalendar();
      }
    }catch(e){
      console.warn('cloudLoad error (ì²« ì‹¤í–‰ì´ê±°ë‚˜ ì˜¤í”„ë¼ì¸ì¼ ìˆ˜ ìˆìŒ)', e);
    }
  }
  // setStore ë˜í•‘: ë¡œì»¬ ì €ì¥ í›„ ì„œë²„ì—ë„ ìë™ ì €ì¥
  (function wrapSetStore(){
    const __orig = setStore;
    window.setStore = function(data){
      __orig(data);
      cloudSaveDebounced(data);
    };
  })();
  // ì‹œì‘ ì‹œ ì›ê²© â†’ ë¡œì»¬ 1íšŒ ë™ê¸°í™”
  cloudLoad();
</script>
</body>
</html>
