<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>출근 월간 캘린더 (Google Sheets 불러오기)</title>
<style>
  :root{ --primary:#16a34a; --red:#e11d48; --blue:#2563eb; --text:#222;
         --sub:#6b7280; --border:#e5e7eb; --bg:#f8fafc; --card:#fff; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Apple SD Gothic Neo','Noto Sans KR',sans-serif;color:var(--text)}
  .wrap{max-width:740px;margin:0 auto;padding:12px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 4px 10px rgba(0,0,0,.04);overflow:hidden}
  .topbar{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border);gap:8px}
  .navbtn{width:36px;height:36px;border-radius:999px;border:1px solid var(--border);background:#fff;display:flex;align-items:center;justify-content:center;font-size:18px;line-height:1;cursor:pointer}
  .title{font-weight:700;font-size:20px;display:flex;align-items:center;gap:8px}
  .actions{display:flex;gap:8px}
  .mini{height:36px;padding:0 12px;border-radius:9px;border:1px solid var(--border);background:#fff;font-weight:600;font-size:13px;cursor:pointer}

  .weekday{display:grid;grid-template-columns:repeat(7,1fr);background:#f3f4f6;border-bottom:1px solid var(--border)}
  .weekday div{padding:10px 0;text-align:center;font-weight:600;color:var(--sub)}
  .weekday div:first-child{color:var(--red)}
  .weekday div:last-child{color:var(--blue)}
  .grid{display:grid;grid-template-columns:repeat(7,1fr);}
  .cell{height:72px;padding:6px 8px;border-right:1px solid var(--border);border-bottom:1px solid var(--border);position:relative;background:#fff}
  .grid .cell:nth-child(7n){border-right:none}
  .date{font-weight:700}
  .sun{color:var(--red)} .sat{color:var(--blue)}
  .muted{color:#c7cdd7}
  .today{outline:2px solid var(--primary);outline-offset:-2px;border-radius:8px}

  .holiday-badge{ position:absolute;left:6px;top:24px;font-size:10px;color:var(--red);font-weight:700;white-space:nowrap }

  .time{ position:absolute;bottom:0;left:0;width:100%;height:22px;line-height:22px;
         text-align:center;font-size:12px;font-weight:600;border-radius:0; }
  .time.sevenEight{ background:#d1d5db; color:#000; } /* 7/8시: 회색 */
  .time.noon{ background:orange; color:#000; }       /* 12시: 주황 */
  .time.off{ background:#d1fae5; color:#16a34a; }   /* 휴무: 연두 */
  .time.special{ background:#000; color:#fff; }     /* 연차/병가/공가/출장/돌봄/사가독서: 검정 */

  #apiStatus{ display:none !important; }

  #modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:50;align-items:flex-end}
  .sheet{width:100%;max-width:740px;margin:0 auto;background:#fff;border-top-left-radius:16px;border-top-right-radius:16px;padding:16px;box-shadow:0 -6px 20px rgba(0,0,0,.15)}
  .sheet h3{margin:0 0 10px 0;font-size:16px}
  .controls{display:flex;gap:8px;margin-top:12px}
  button{height:40px;border-radius:10px;border:1px solid var(--border);background:#fff;padding:0 14px;font-weight:600;cursor:pointer}
  .primary{background:var(--primary);border-color:var(--primary);color:#fff}
  .danger{background:#fff;border-color:#ef4444;color:#ef4444}
  select{width:100%;height:44px;border:1px solid var(--border);border-radius:10px;padding:0 10px;font-size:16px;background:#fff}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="topbar">
        <button class="navbtn" id="prevBtn" aria-label="이전 달">◀</button>
        <div class="title"><span id="monthTitle">YYYY. MM.</span><span id="apiStatus"></span></div>
        <div class="actions">
          <button class="mini" id="sheetLoadBtn">시트 불러오기</button>
          <button class="navbtn" id="nextBtn" aria-label="다음 달">▶</button>
        </div>
      </div>
      <div class="weekday">
        <div>일</div><div>월</div><div>화</div><div>수</div><div>목</div><div>금</div><div>토</div>
      </div>
      <div class="grid" id="grid"></div>
    </div>
  </div>

  <!-- 수동 입력 모달(로컬 전용) -->
  <div id="modal" aria-modal="true" role="dialog">
    <div class="sheet">
      <h3 id="modalDate">YYYY-MM-DD 출근/상태</h3>
      <select id="timeSelect">
        <option value="">선택</option>
        <option value="7시">7시</option>
        <option value="8시">8시</option>
        <option value="12시">12시</option>
        <option value="휴무">휴무</option>
        <option value="연차">연차</option>
        <option value="병가">병가</option>
        <option value="공가">공가</option>
        <option value="출장">출장</option>
        <option value="돌봄">돌봄</option>
        <option value="사가독서">사가독서</option>
      </select>
      <div class="controls">
        <button class="primary" id="saveBtn">저장(로컬)</button>
        <button class="danger" id="clearBtn">삭제(로컬)</button>
        <button id="cancelBtn">취소</button>
      </div>
      <p style="margin:8px 0 0;color:#6b7280;font-size:12px">
        * “시트 불러오기”를 하면 구글시트 내용으로 다시 덮어씁니다.
      </p>
    </div>
  </div>

<script>
  /* ====== 환경설정 ====== */
  const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbwOsLnB6PqwsmzpDQvAyjSQkE9T81S2bBFrWVcpOS3bEZNeyU9x8VlyU71urs8mfk1I/exec'; // 예: https://script.google.com/macros/s/XXXX/exec
  const SERVICE_KEY = ""; // (옵션) 공휴일 API 키가 있으면 넣으세요
  const USE_HOLIDAYS = !!SERVICE_KEY;
  const HOLIDAY_TTL_DAYS = 7;

  /* ====== 엘리먼트 ====== */
  const grid = document.getElementById('grid');
  const monthTitle = document.getElementById('monthTitle');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const sheetLoadBtn = document.getElementById('sheetLoadBtn');
  const modal = document.getElementById('modal');
  const modalDate = document.getElementById('modalDate');
  const timeSelect = document.getElementById('timeSelect');
  const saveBtn = document.getElementById('saveBtn');
  const clearBtn = document.getElementById('clearBtn');
  const cancelBtn = document.getElementById('cancelBtn');

  /* ====== 상태/유틸 ====== */
  let state = (()=>{ const now=new Date(); return {year:now.getFullYear(), month:now.getMonth()}; })();
  let selectedKey = null;
  const storeKey = 'workTimes';
  function getStore(){ try{ return JSON.parse(localStorage.getItem(storeKey) || '{}'); }catch{ return {}; } }
  function setStore(data){ localStorage.setItem(storeKey, JSON.stringify(data)); }
  function pad(n){ return n.toString().padStart(2,'0'); }
  function keyOf(y,m,d){ return `${y}-${pad(m+1)}-${pad(d)}`; }

  /* ====== (옵션) 공휴일 ====== */
  function holidayCacheKey(year){ return `holidays_${year}_v3`; }
  function isCacheFresh(ts){ return ts && (Date.now()-ts) <= HOLIDAY_TTL_DAYS*86400000; }
  async function fetchHolidaysByMonth(year, month){
    try{
      const solMonth = pad(month+1);
      const url = `https://apis.data.go.kr/B090041/openapi/service/SpcdeInfoService/getRestDeInfo?solYear=${year}&solMonth=${solMonth}&numOfRows=100&_type=json&ServiceKey=${encodeURIComponent(SERVICE_KEY)}`;
      const res = await fetch(url);
      if(!res.ok) throw new Error(res.status);
      const data = await res.json();
      const items = (((data||{}).response||{}).body||{}).items;
      const arr = items && items.item ? (Array.isArray(items.item)?items.item:[items.item]) : [];
      const map = {};
      for(const it of arr){
        const ymd = String(it.locdate);
        if(/^\d{8}$/.test(ymd)){
          const k = `${ymd.slice(0,4)}-${ymd.slice(4,6)}-${ymd.slice(6,8)}`;
          map[k] = it.dateName || '';
        }
      }
      return map;
    }catch{ return {}; }
  }
  let holidayMap = {};
  let holidayYear = null;

  /* ====== 캘린더 렌더 ====== */
  function drawCalendar(){
    const y=state.year, m=state.month;
    monthTitle.textContent = `${y}. ${pad(m+1)}.`;
    const first=new Date(y,m,1);
    const lastDate=new Date(y,m+1,0).getDate();
    const startDay=first.getDay();
    const totalCells=Math.ceil((startDay+lastDate)/7)*7;

    grid.innerHTML='';
    const today=new Date();
    const store=getStore();

    for(let i=0;i<totalCells;i++){
      const cell=document.createElement('div');
      cell.className='cell';
      const dayIndex=i-startDay+1;

      if(dayIndex<1||dayIndex>lastDate){
        cell.classList.add('muted'); cell.innerHTML='&nbsp;';
      }else{
        const dow=i%7;
        if(dow===0) cell.classList.add('sun');
        if(dow===6) cell.classList.add('sat');

        const dateEl=document.createElement('div');
        dateEl.className='date';
        dateEl.textContent=dayIndex;
        cell.appendChild(dateEl);

        const k=keyOf(y,m,dayIndex);
        const val=store[k];

        if(holidayMap && holidayMap[k]){
          const badge=document.createElement('div');
          badge.className='holiday-badge';
          badge.textContent=holidayMap[k];
          cell.appendChild(badge);
          cell.classList.add('sun');
        }

        if(val){
          const t=document.createElement('div');
          t.className='time';
          t.textContent=val;
          if (val==='7시'||val==='8시') t.classList.add('sevenEight');
          else if (val==='12시') t.classList.add('noon');
          else if (val==='휴무') t.classList.add('off');
          else if (['연차','병가','공가','출장','돌봄','사가독서'].includes(val)) t.classList.add('special');
          cell.appendChild(t);
        }

        if(today.getFullYear()===y && today.getMonth()===m && today.getDate()===dayIndex){
          cell.classList.add('today');
        }

        cell.addEventListener('click', ()=> openModal(k, val || ''));
      }
      grid.appendChild(cell);
    }
  }

  async function render(){
    drawCalendar(); // 먼저 그림
    // 공휴일(옵션)
    if (USE_HOLIDAYS){
      const y = state.year;
      if (holidayYear !== y){
        holidayYear = y;
        const cacheKey = holidayCacheKey(y);
        let cached = null;
        try{ cached = JSON.parse(localStorage.getItem(cacheKey)||'null'); }catch{}
        if (cached && isCacheFresh(cached.ts)){ holidayMap=cached.data||{}; drawCalendar(); }
        else{
          const all={};
          for(let m=0;m<12;m++) Object.assign(all, await fetchHolidaysByMonth(y,m));
          holidayMap = all;
          localStorage.setItem(cacheKey, JSON.stringify({ data:all, ts:Date.now() }));
          drawCalendar();
        }
      }
    }
  }

  /* ====== 모달(로컬 전용) ====== */
  function openModal(key, value){
    selectedKey=key;
    modalDate.textContent = key+' 출근/상태';
    timeSelect.value = value || '';
    modal.style.display='flex';
  }
  function closeModal(){ modal.style.display='none'; }
  saveBtn.addEventListener('click', ()=>{
    if(!selectedKey) return;
    const store=getStore();
    store[selectedKey]=timeSelect.value||'';
    setStore(store);
    closeModal();
    drawCalendar();
  });
  clearBtn.addEventListener('click', ()=>{
    if(!selectedKey) return;
    const store=getStore();
    delete store[selectedKey];
    setStore(store);
    closeModal();
    drawCalendar();
  });
  cancelBtn.addEventListener('click', closeModal);
  modal.addEventListener('click', (e)=>{ if(e.target===modal) closeModal(); });

  /* ====== 월 이동 ====== */
  prevBtn.addEventListener('click', ()=>{ state.month--; if(state.month<0){state.month=11; state.year--; } render(); });
  nextBtn.addEventListener('click', ()=>{ state.month++; if(state.month>11){state.month=0; state.year++; } render(); });

  /* ====== Google 시트 불러오기 ====== */
  async function loadFromSheet(){
    try{
      const res = await fetch(WEBAPP_URL + '?_=' + Date.now());
      const j = await res.json();
      if (!j || !j.ok) { alert('시트 불러오기 실패: ' + (j && j.error ? j.error : '응답 오류')); return; }
      // 서버 데이터 → 로컬 저장소에 그대로 덮어쓰기
      localStorage.setItem(storeKey, JSON.stringify(j.data || {}));
      drawCalendar();
      alert('시트에서 불러왔습니다.');
    }catch(e){
      alert('시트 불러오기 실패: ' + e.message);
      console.error(e);
    }
  }
  sheetLoadBtn.addEventListener('click', loadFromSheet);

  /* ====== 시작 ====== */
  render();
  // 첫 로딩 시 자동 1회 불러오기
  loadFromSheet().catch(()=>{ /* 네트워크 문제 등은 조용히 무시 */ });
</script>
</body>
</html>
