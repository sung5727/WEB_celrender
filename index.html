<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>출근 월간 캘린더 (공휴일 API + 엑셀 불러오기 + 월 전체삭제)</title>
<style>
  :root{
    --primary:#16a34a;
    --red:#e11d48;
    --blue:#2563eb;
    --text:#222;
    --sub:#6b7280;
    --border:#e5e7eb;
    --bg:#f8fafc;
    --card:#ffffff;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Apple SD Gothic Neo','Noto Sans KR',sans-serif;color:var(--text)}
  .wrap{max-width:740px;margin:0 auto;padding:12px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 4px 10px rgba(0,0,0,.04);overflow:hidden}
  .topbar{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border);gap:8px}
  .navbtn{width:36px;height:36px;border-radius:999px;border:1px solid var(--border);background:#fff;display:flex;align-items:center;justify-content:center;font-size:18px;line-height:1}
  .title{font-weight:700;font-size:20px;display:flex;align-items:center;gap:8px}
  .actions{display:flex;gap:8px}
  .mini{height:36px;padding:0 12px;border-radius:9px;border:1px solid var(--border);background:#fff;font-weight:600;font-size:13px}
  .weekday{display:grid;grid-template-columns:repeat(7,1fr);background:#f3f4f6;border-bottom:1px solid var(--border)}
  .weekday div{padding:10px 0;text-align:center;font-weight:600;color:var(--sub)}
  .weekday div:first-child{color:var(--red)}
  .weekday div:last-child{color:var(--blue)}
  .grid{display:grid;grid-template-columns:repeat(7,1fr);}
  .cell{height:72px;padding:6px 8px;border-right:1px solid var(--border);border-bottom:1px solid var(--border);position:relative;background:#fff}
  .grid .cell:nth-child(7n){border-right:none}
  .date{font-weight:700}
  .sun{color:var(--red)}
  .sat{color:var(--blue)}
  .muted{color:#c7cdd7}
  .today{outline:2px solid var(--primary);outline-offset:-2px;border-radius:8px}

  /* 공휴일 배지: 날짜 바로 아래(왼쪽) */
  .holiday-badge{
    position:absolute;left:6px;top:24px;font-size:10px;
    color:var(--red);font-weight:700;white-space:nowrap
  }

  /* 출근시간 표시(오른쪽 하단) - 기본 스타일 */
  .time {
  position:absolute;
  bottom:0;       /* 칸 맨 아래 붙이기 */
  left:0;
  width:100%;     /* 가로 전체 채움 */
  height:22px;    /* 원하는 높이 */
  line-height:22px;
  text-align:center;
  font-size:12px;
  font-weight:600;
  border-radius:0;  /* 모서리 둥글기 제거 (원하면 살려도 됨) */
}
  /* 7시 / 8시: 연한 회색 배경 + 검정 글씨 */
  .time.sevenEight{
    background:#d1d5db; color:#000;
  }
  /* 12시: 주황 배경 + 흰 글씨 */
  .time.noon{
    background:orange; color:#000;
  }
  /* 휴무: 연두 배경 + 초록 글씨 */
  .time.off{
    background:#d1fae5; color:#16a34a;
  }

  /* 공휴일 상태 텍스트는 화면에 숨김 */
  #apiStatus { display:none !important; }

  /* Modal */
  #modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:50;align-items:flex-end}
  .sheet{width:100%;max-width:740px;margin:0 auto;background:#fff;border-top-left-radius:16px;border-top-right-radius:16px;padding:16px;box-shadow:0 -6px 20px rgba(0,0,0,.15)}
  .sheet h3{margin:0 0 10px 0;font-size:16px}
  .controls{display:flex;gap:8px;margin-top:12px}
  button{height:40px;border-radius:10px;border:1px solid var(--border);background:#fff;padding:0 14px;font-weight:600}
  .primary{background:var(--primary);border-color:var(--primary);color:#fff}
  .danger{background:#fff;border-color:#ef4444;color:#ef4444}
  select{width:100%;height:44px;border:1px solid var(--border);border-radius:10px;padding:0 10px;font-size:16px;background:#fff}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="topbar">
        <button class="navbtn" id="prevBtn" aria-label="이전 달">◀</button>
        <div class="title">
          <span id="monthTitle">YYYY. MM.</span>
          <span id="apiStatus" aria-live="polite"></span>
        </div>
        <div class="actions">
          <button class="mini" id="importBtn" title="엑셀에서 불러오기">업로드</button>
          <button class="mini" id="wipeMonthBtn" title="현재 보고있는 달의 입력 전체 삭제">삭제</button>
          <button class="navbtn" id="nextBtn" aria-label="다음 달">▶</button>
        </div>
      </div>
      <div class="weekday">
        <div>일</div><div>월</div><div>화</div><div>수</div><div>목</div><div>금</div><div>토</div>
      </div>
      <div class="grid" id="grid"></div>
    </div>
  </div>

  <!-- Modal -->
  <div id="modal" aria-modal="true" role="dialog">
    <div class="sheet">
      <h3 id="modalDate">YYYY-MM-DD 출근 시간</h3>
      <select id="timeSelect" aria-label="출근 시간 선택">
        <option value="">선택</option>
        <option value="7시">7시</option>
        <option value="8시">8시</option>
        <option value="12시">12시</option>
        <option value="휴무">휴무</option>
      </select>
      <div class="controls">
        <button class="primary" id="saveBtn">저장</button>
        <button class="danger" id="clearBtn">삭제</button>
        <button id="cancelBtn">취소</button>
      </div>
    </div>
  </div>

  <!-- 파일 선택(숨김) -->
  <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display:none" />

  <!-- SheetJS (XLSX 파서) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
  /* ========= 설정 ========= */
  const SERVICE_KEY = "f3fe3ff25a8fe96c692eacced03e726ebf3443ee7cdd8e50a1d06a1b0d7ee8cf"; // ← 본인 공휴일 API 키를 넣으세요
  const HOLIDAY_TTL_DAYS = 7;          // 공휴일 캐시 유지 기간(일)

  /* ========= 엘리먼트 ========= */
  const grid = document.getElementById('grid');
  const monthTitle = document.getElementById('monthTitle');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const importBtn = document.getElementById('importBtn');
  const wipeMonthBtn = document.getElementById('wipeMonthBtn');
  const fileInput = document.getElementById('fileInput');
  const modal = document.getElementById('modal');
  const modalDate = document.getElementById('modalDate');
  const timeSelect = document.getElementById('timeSelect');
  const saveBtn = document.getElementById('saveBtn');
  const cancelBtn = document.getElementById('cancelBtn');
  const clearBtn = document.getElementById('clearBtn');
  const apiStatus = document.getElementById('apiStatus');

  /* ========= 상태 ========= */
  let state = (()=>{ const now = new Date(); return { year: now.getFullYear(), month: now.getMonth() }; })();
  let selectedKey = null;
  const storeKey = 'workTimes';

  /* ========= 유틸 ========= */
  function getStore(){ try{ return JSON.parse(localStorage.getItem(storeKey) || '{}'); } catch(e){ return {}; } }
  function setStore(data){ localStorage.setItem(storeKey, JSON.stringify(data)); }
  function pad(n){ return n.toString().padStart(2,'0'); }
  function keyOf(y,m,d){ return `${y}-${pad(m+1)}-${pad(d)}`; }
  function holidayCacheKey(year){ return `holidays_${year}_v2`; }
  function isCacheFresh(ts){ return ts && (Date.now() - ts) <= HOLIDAY_TTL_DAYS*24*60*60*1000; }

  /* ========= 공휴일 API ========= */
  async function fetchHolidaysByMonth(year, month) {
    const solMonth = pad(month+1);
    const url = `https://apis.data.go.kr/B090041/openapi/service/SpcdeInfoService/getRestDeInfo?` +
                `solYear=${year}&solMonth=${solMonth}&numOfRows=100&_type=json&ServiceKey=${encodeURIComponent(SERVICE_KEY)}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error('API 응답 오류: ' + res.status);
    const data = await res.json();
    const items = (((data||{}).response||{}).body||{}).items;

    const arr = items && items.item
      ? (Array.isArray(items.item) ? items.item : [items.item])
      : [];

    const map = {};
    for (const it of arr) {
      const ymd = String(it.locdate); // 20250129
      if (!/^\d{8}$/.test(ymd)) continue;
      const key = `${ymd.slice(0,4)}-${ymd.slice(4,6)}-${ymd.slice(6,8)}`;
      map[key] = it.dateName;         // 설날/추석/대체공휴일 등
    }
    return map;
  }

  async function fetchHolidaysForYear(year) {
    try {
      const promises = [];
      for (let m=0; m<12; m++) promises.push(fetchHolidaysByMonth(year, m));
      const monthly = await Promise.all(promises);
      const all = Object.assign({}, ...monthly);
      return { data: all, ts: Date.now() };
    } catch (e) {
      console.error(e);
      return { data: {}, ts: 0 };
    }
  }

  async function getHolidayMap(year){
    const key = holidayCacheKey(year);
    const cached = localStorage.getItem(key);
    if (cached){
      try {
        const obj = JSON.parse(cached);
        if (isCacheFresh(obj.ts)) {
          apiStatus.textContent = '공휴일 캐시 사용'; // 화면에는 숨김
          return obj.data || {};
        }
      } catch {}
    }
    apiStatus.textContent = '공휴일 불러오는 중…';
    const fresh = await fetchHolidaysForYear(year);
    localStorage.setItem(key, JSON.stringify(fresh));
    apiStatus.textContent = '공휴일 최신화 완료';
    return fresh.data || {};
  }

  /* ========= 렌더 ========= */
  let currentHolidayMap = {};
  let currentHolidayYear = null;

  async function render(){
    const y = state.year, m = state.month;
    monthTitle.textContent = `${y}. ${pad(m+1)}.`;
    if (currentHolidayYear !== y){
      currentHolidayMap = await getHolidayMap(y);
      currentHolidayYear = y;
    }
    drawCalendar(currentHolidayMap);
  }

  function drawCalendar(holidayMap){
    const y = state.year, m = state.month;
    const first = new Date(y,m,1);
    const lastDate = new Date(y,m+1,0).getDate();
    const startDay = first.getDay();
    const totalCells = Math.ceil((startDay + lastDate) / 7) * 7;

    grid.innerHTML = '';
    const today = new Date();
    const store = getStore();

    for(let i=0;i<totalCells;i++){
      const cell = document.createElement('div');
      cell.className = 'cell';
      const dayIndex = i - startDay + 1;

      if(dayIndex < 1 || dayIndex > lastDate){
        cell.classList.add('muted');
        cell.innerHTML = '&nbsp;';
      } else {
        const dow = (i % 7);
        if(dow===0) cell.classList.add('sun');
        if(dow===6) cell.classList.add('sat');

        const dateEl = document.createElement('div');
        dateEl.className = 'date';
        dateEl.textContent = dayIndex;
        cell.appendChild(dateEl);

        const k = keyOf(y,m,dayIndex);
        const value = store[k];

        // 공휴일 배지
        if (holidayMap[k]) {
          cell.classList.add('sun');
          const badge = document.createElement('div');
          badge.className = 'holiday-badge';
          badge.textContent = holidayMap[k];
          cell.appendChild(badge);
        }

        // 출근시간 표시 (오른쪽 하단)
        if(value){
          const t = document.createElement('div');
          t.className = 'time';
          t.textContent = value;

          if (value === '7시' || value === '8시') t.classList.add('sevenEight');
          if (value === '12시') t.classList.add('noon');
          if (value === '휴무') t.classList.add('off');

          cell.appendChild(t);
        }

        // 오늘 강조
        if(today.getFullYear()===y && today.getMonth()===m && today.getDate()===dayIndex){
          cell.classList.add('today');
        }

        cell.addEventListener('click', ()=> openModal(k, value || ''));
      }
      grid.appendChild(cell);
    }
  }

  /* ========= 모달 ========= */
  function openModal(key, value){
    selectedKey = key;
    modalDate.textContent = key + ' 출근 시간';
    timeSelect.value = value || '';
    modal.style.display = 'flex';
  }
  function closeModal(){ modal.style.display = 'none'; }

  /* ========= 월 네비게이션 ========= */
  prevBtn.addEventListener('click', async ()=>{
    state.month--;
    if(state.month<0){ state.month=11; state.year--; }
    await render();
  });
  nextBtn.addEventListener('click', async ()=>{
    state.month++;
    if(state.month>11){ state.month=0; state.year++; }
    await render();
  });

  /* ========= 저장/삭제 ========= */
  saveBtn.addEventListener('click', ()=>{
    if(!selectedKey) return;
    const store = getStore();
    store[selectedKey] = timeSelect.value || '';
    setStore(store);
    closeModal();
    render();
  });
  clearBtn.addEventListener('click', ()=>{
    if(!selectedKey) return;
    const store = getStore();
    delete store[selectedKey];
    setStore(store);
    closeModal();
    render();
  });
  cancelBtn.addEventListener('click', closeModal);
  modal.addEventListener('click', (e)=>{ if(e.target===modal) closeModal(); });

  /* ========= 엑셀 불러오기 ========= */
  function toKeyFromExcelDate(v){
    if (v == null || v === '') return null;
    if (typeof v === 'number') {
      const date = XLSX.SSF.parse_date_code(v);
      if (!date) return null;
      const y = date.y, m = date.m, d = date.d;
      return `${y}-${pad(m)}-${pad(d)}`;
    }
    let s = String(v).trim();
    s = s.replace(/[./]/g, '-').replace(/\s+/g, '');
    const mm = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
    if (mm) {
      const y = parseInt(mm[1],10), mo = parseInt(mm[2],10), d = parseInt(mm[3],10);
      if (!isNaN(y) && !isNaN(mo) && !isNaN(d)) return `${y}-${pad(mo)}-${pad(d)}`;
    }
    const dt = new Date(s);
    if (!isNaN(dt)) return `${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())}`;
    return null;
  }
  function normalizeHeader(h){
    if(!h) return '';
    return String(h).toLowerCase().replace(/\s+/g,'').replace(/[^\w가-힣]/g,'');
  }
  function isWorkTimeValue(v){
    return v === '7시' || v === '8시' || v === '12시' || v === '휴무';
  }

  importBtn.addEventListener('click', ()=> fileInput.click());
  fileInput.addEventListener('change', async (e)=>{
    const file = e.target.files && e.target.files[0];
    if (!file) return;

    try {
      const ext = (file.name.split('.').pop() || '').toLowerCase();
      let rows = [];

      if (ext === 'csv') {
        const text = await file.text();
        rows = text.split(/\r?\n/).map(r => r.split(','));
      } else {
        const data = await file.arrayBuffer();
        const wb = XLSX.read(data, { type:'array' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        rows = XLSX.utils.sheet_to_json(ws, { header:1, raw:true });
      }

      if (!rows.length) { alert('엑셀/CSV에서 데이터를 찾지 못했습니다.'); return; }

      const header = rows[0] || [];
      const nh = header.map(normalizeHeader);

      const idxDate = nh.findIndex(x => ['날짜','date','일자'].includes(x));
      const idxTime = nh.findIndex(x => ['출근시간','출근','근무','time','근무시간'].includes(x));
      if (idxDate === -1 || idxTime === -1) {
        alert('헤더에 "날짜"와 "출근시간" 열이 필요합니다. (예: 날짜, 요일, 출근시간)');
        return;
      }

      const store = getStore();
      let applied = 0, skipped = 0;
      for (let r = 1; r < rows.length; r++){
        const row = rows[r];
        if (!row || row.length === 0) continue;

        const rawDate = row[idxDate];
        const key = toKeyFromExcelDate(rawDate);
        if (!key) { skipped++; continue; }

        const rawTime = (row[idxTime] ?? '').toString().trim();
        if (!isWorkTimeValue(rawTime)) { skipped++; continue; }

        store[key] = rawTime;
        applied++;
      }

      setStore(store);
      render();
      alert(`불러오기 완료\n적용: ${applied}건, 건너뜀: ${skipped}건`);
    } catch(err){
      console.error(err);
      alert('엑셀 불러오기에 실패했습니다. 파일 형식과 헤더를 확인해주세요.');
    } finally {
      fileInput.value = '';
    }
  });

  /* ========= 해당월 전체 삭제 ========= */
  function wipeCurrentMonth(){
    const y = state.year, m = state.month;
    const lastDate = new Date(y,m+1,0).getDate();
    const store = getStore();

    let count = 0;
    for (let d=1; d<=lastDate; d++){
      const k = keyOf(y,m,d);
      if (store.hasOwnProperty(k)) {
        delete store[k];
        count++;
      }
    }
    setStore(store);
    return count;
  }

  wipeMonthBtn.addEventListener('click', ()=>{
    const label = `${state.year}-${pad(state.month+1)}`;
    if (!confirm(`"${label}" 월의 입력을 모두 삭제할까요?\n(되돌릴 수 없습니다)`)) return;
    const removed = wipeCurrentMonth();
    render();
    alert(`"${label}" 월에서 ${removed}건 삭제되었습니다.`);
  });

  /* ========= 시작 ========= */
  render();
</script>

</body>
</html>
