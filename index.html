<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ì¶œê·¼ìº˜ë¦°ë”</title>
<style>
  :root{ --primary:#16a34a; --red:#e11d48; --blue:#2563eb; --text:#222; --sub:#6b7280; --border:#e5e7eb; --bg:#f8fafc; --card:#fff; }
  *{box-sizing:border-box}
  body{ margin:0;background:var(--bg);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Apple SD Gothic Neo','Noto Sans KR',sans-serif;
    color:var(--text); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; text-rendering:geometricPrecision; }
  .wrap{max-width:740px;margin:0 auto;padding:12px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 4px 10px rgba(0,0,0,.04);overflow:hidden}

  .topbar{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border);gap:8px}
  .title{font-weight:700;font-size:20px;display:flex;align-items:center;gap:8px}
  .actions{display:flex;gap:8px}

  button{height:40px;border-radius:10px;border:1px solid var(--border);background:#fff;padding:0 14px;font-weight:600;cursor:pointer}
  .primary{background:var(--primary);border-color:var(--primary);color:#fff}
  .danger{background:#ef4444;border-color:#ef4444;color:#fff}
  .mini{height:36px;padding:0 12px;border-radius:9px;border:1px solid var(--border);background:#fff;font-weight:600;font-size:13px;cursor:pointer}
  .navbtn{width:36px;height:36px;border-radius:999px;border:1px solid var(--border);background:#fff;display:flex;align-items:center;justify-content:center;font-size:18px;line-height:1;cursor:pointer}

  .weekday{display:grid;grid-template-columns:repeat(7,1fr);background:#f3f4f6;border-bottom:1px solid var(--border)}
  .weekday div{padding:10px 0;text-align:center;font-weight:600;color:var(--sub)}
  .weekday div:first-child{color:var(--red)}
  .weekday div:last-child{color:var(--blue)}

  .grid{ display:grid;grid-template-columns:repeat(7,1fr); touch-action: pan-y; }
  .cell{ height:72px; padding:22px 8px 6px 8px; border-right:1px solid var(--border); border-bottom:1px solid var(--border);
    position:relative;background:#fff;overflow:hidden; }
  .grid .cell:nth-child(7n){border-right:none}

  .date{ position:absolute; left:8px; top:6px; font-weight:700; line-height:1; z-index:1; }
  .sun .date{color:var(--red)} .sat .date{color:var(--blue)}
  .muted{color:#c7cdd7}
  .edge .date{ color:#c7cdd7; } .edge .time{ opacity:.55; }

  .today {background:#f5f5f5}
  .today .date { color:#000;font-weight:700;text-decoration: underline; text-decoration-thickness: 1px; text-underline-offset: 3px; }

  /* ê³µíœ´ì¼: ì´ë²ˆë‹¬ì€ ì§„í•œ ë¹¨ê°•, ì „ì›”/ìµì›”(ì—£ì§€)ì€ íë¦¬ê²Œ */
  .holiday .date { color: var(--red); }
  .edge.holiday .date { color: rgba(225,29,72,0.5); }
  .holiday-badge{ position:absolute;left:8px;top:26px;font-size:10px;color:var(--red);font-weight:700;white-space:nowrap;z-index:1; }
  .edge .holiday-badge{ color:rgba(225,29,72,0.5); }

  .time{ position:absolute;bottom:0;left:0;width:100%;height:22px;line-height:22px;text-align:center;font-size:13px;font-weight:600;border-radius:0; }
  .time.sevenEight{ background:#E5E5E5; color:#000; } .time.noon{ background:#8ECAE6; color:#000; }
  .time.off{ background:#FFB703; color:#000; } .time.special{ background:#219EBC; color:#000; }
  .time.special_small{ font-size:12px; background:#219EBC; color:#000; }

  #modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:50;align-items:flex-end}
  #modal.show{display:flex;}
  .sheet{width:100%;max-width:740px;margin:0 auto;background:#fff;border-top-left-radius:16px;border-top-right-radius:16px;padding:16px;box-shadow:0 -6px 20px rgba(0,0,0,.15)}
  .sheet h3{margin:0 0 10px 0;font-size:16px}
  .controls{display:flex;gap:8px;margin-top:12px}
  select{width:100%;height:44px;border:1px solid var(--border);border-radius:10px;padding:0 10px;font-size:16px;background:#fff}

  .section-divider{ height:1px;background:var(--border); margin:12px 0 4px 0; border-radius:1px; }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="topbar">
        <button class="navbtn" id="prevBtn">â—€</button>
        <div class="title">
          <span id="monthTitle">YYYY. MM.</span>
        </div>
        <div class="actions">
          <button class="mini" id="sheetLoadBtn">ë¶ˆëŸ¬ì˜¤ê¸°</button>
          <button class="navbtn" id="nextBtn">â–¶</button>
        </div>
      </div>

      <div id="calendarCapture">
        <div class="weekday">
          <div>ì¼</div><div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div>í† </div>
        </div>
        <div class="grid" id="grid"></div>
      </div>
    </div>
    <div class="section-divider"></div>
  </div>

  <!-- ëª¨ë‹¬ -->
  <div id="modal">
    <div class="sheet">
      <h3 id="modalDate">YYYY-MM-DD ì¶œê·¼/ìƒíƒœ</h3>
      <select id="timeSelect">
        <option value="">ì„ íƒ</option>
        <option value="7ì‹œ">7ì‹œ</option><option value="8ì‹œ">8ì‹œ</option>
        <option value="12ì‹œ">12ì‹œ</option><option value="íœ´ë¬´">íœ´ë¬´</option>
        <option value="ì—°ì°¨">ì—°ì°¨</option><option value="ë³‘ê°€">ë³‘ê°€</option>
        <option value="ê³µê°€">ê³µê°€</option><option value="ì¶œì¥">ì¶œì¥</option>
        <option value="ëŒë´„">ëŒë´„</option><option value="ì‚¬ê°€ë…ì„œ">ì‚¬ê°€ë…ì„œ</option>
        <option value="ì²´ë ¨ëŒ€íšŒ">ì²´ë ¨ëŒ€íšŒ</option>
      </select>
      <div class="controls">
        <button class="primary" id="saveBtn">ì €ì¥</button>
        <button class="danger" id="clearBtn">ì‚­ì œ</button>
        <button id="cancelBtn">ì·¨ì†Œ</button>
      </div>
    </div>
  </div>

<script>
  /* ===== ê¸°ë³¸ ìƒìˆ˜ ===== */
  const WEBAPP_URL  = 'https://script.google.com/macros/s/AKfycbwA1CtxLfbziu52wTUa-R4TKrN4NQajVtFKDVwYBFhGalUPU3QcHbK24mueAMkI8DLM/exec';
  const SERVICE_KEY = 'f3fe3ff25a8fe96c692eacced03e726ebf3443ee7cdd8e50a1d06a1b0d7ee8cf';
  const USE_HOLIDAYS = SERVICE_KEY && SERVICE_KEY.trim().length > 0;
  const SERVICE_KEY_PARAM = encodeURIComponent(SERVICE_KEY);

  /* ===== ì—˜ë¦¬ë¨¼íŠ¸ ===== */
  const grid=document.getElementById('grid');
  const monthTitle=document.getElementById('monthTitle');
  const prevBtn=document.getElementById('prevBtn');
  const nextBtn=document.getElementById('nextBtn');
  const sheetLoadBtn=document.getElementById('sheetLoadBtn');
  const modal=document.getElementById('modal');
  const modalDate=document.getElementById('modalDate');
  const timeSelect=document.getElementById('timeSelect');
  const saveBtn=document.getElementById('saveBtn');
  const clearBtn=document.getElementById('clearBtn');
  const cancelBtn=document.getElementById('cancelBtn');

  /* ===== ìƒíƒœ ===== */
  let state=(()=>{try{const s=localStorage.getItem('lastView');if(s){const o=JSON.parse(s);if(o.year&&o.month>=0)return o;}}catch(e){};const n=new Date();return{year:n.getFullYear(),month:n.getMonth()};})();
  let selectedKey=null; let sheetData={}; let holidayMap={};

  /* ===== ìœ í‹¸ ===== */
  const pad=n=>n.toString().padStart(2,'0');
  const keyOf=(y,m,d)=>`${y}-${pad(m+1)}-${pad(d)}`;
  function ymAdd(year, month, delta){ const d=new Date(year, month+delta, 1); return {y:d.getFullYear(), m:d.getMonth()}; }

  /* ===== ë„¤íŠ¸ì›Œí¬ ë³´ì¡°(íƒ€ì„ì•„ì›ƒ) ===== */
  async function fetchWithTimeout(url, ms, init={}){
    const ctl = new AbortController();
    const t = setTimeout(()=>ctl.abort('timeout'), ms);
    try{ return await fetch(url, {...init, signal:ctl.signal}); }
    finally{ clearTimeout(t); }
  }

  /* ===== ê³µíœ´ì¼ ìºì‹œ (localStorage) ===== */
  const HOLI_CACHE_KEY = 'holidayCacheV1'; // { "YYYY-MM": { at:ts, data:{'YYYY-MM-DD':'ì´ë¦„'} } }
  const HOLI_TTL = 7*24*60*60*1000; // 7ì¼

  function holiRead(ym){ try{ const raw=localStorage.getItem(HOLI_CACHE_KEY); if(!raw) return null;
    const box=JSON.parse(raw)||{}; const hit=box[ym]; if(!hit) return null;
    if(Date.now()-hit.at > HOLI_TTL) return null; return hit.data||null;
  }catch(e){ return null; } }

  function holiWrite(ym, data){ try{
    const raw=localStorage.getItem(HOLI_CACHE_KEY); const box=raw?JSON.parse(raw):{};
    box[ym] = { at: Date.now(), data };
    localStorage.setItem(HOLI_CACHE_KEY, JSON.stringify(box));
  }catch(e){} }

  async function fetchHolidays(year,month){
    if(!USE_HOLIDAYS) return {};
    const ym = `${year}-${pad(month+1)}`;
    const cached = holiRead(ym);
    if(cached) return cached;

    const url=`https://apis.data.go.kr/B090041/openapi/service/SpcdeInfoService/getRestDeInfo?solYear=${year}&solMonth=${pad(month+1)}&numOfRows=50&_type=json&ServiceKey=${SERVICE_KEY_PARAM}`;
    const res=await fetchWithTimeout(url, 4500);
    if(!res.ok) return {};
    const data=await res.json();
    const items=(((data||{}).response||{}).body||{}).items;
    const arr=items&&items.item?(Array.isArray(items.item)?items.item:[items.item]):[];
    const map={};
    for(const it of arr){
      const ymd=String(it.locdate||'');
      if(/^\d{8}$/.test(ymd)){
        const k=`${ymd.slice(0,4)}-${ymd.slice(4,6)}-${ymd.slice(6,8)}`;
        map[k]=it.dateName||'';
      }
    }
    holiWrite(ym, map);
    return map;
  }

  /* ===== ì‹œíŠ¸ ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° ===== */
  async function reloadFromSheet(){
    const res=await fetchWithTimeout(WEBAPP_URL+'?_='+Date.now(), 6000);
    const j=await res.json(); if(j&&j.ok) sheetData=j.data||{};
  }
  async function saveToSheet(key,value){
    const p=new URLSearchParams();p.set('payload',JSON.stringify({mode:'set',key,value}));
    await fetchWithTimeout(WEBAPP_URL, 6000,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:p.toString()});
  }
  async function deleteFromSheet(key){
    const p=new URLSearchParams();p.set('payload',JSON.stringify({mode:'delete',key}));
    await fetchWithTimeout(WEBAPP_URL, 6000,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:p.toString()});
  }

  /* ===== ë‹¬ë ¥ ê·¸ë¦¬ê¸° ===== */
  function drawCalendar(){
    const y=state.year,m=state.month;
    monthTitle.textContent=`${y}. ${pad(m+1)}.`;
    const firstDay=new Date(y,m,1).getDay();
    const lastDate=new Date(y,m+1,0).getDate();
    const prevLast=new Date(y,m,0).getDate();
    const totalCells=Math.ceil((firstDay+lastDate)/7)*7;

    grid.innerHTML='';
    const today=new Date();

    for(let i=0;i<totalCells;i++){
      const cell=document.createElement('div');cell.className='cell';
      let dNum,cYear,cMonth,isEdge=false;
      if(i<firstDay){ dNum=prevLast-firstDay+i+1; cYear=(m===0?y-1:y); cMonth=(m===0?11:m-1); isEdge=true; }
      else if(i>=firstDay+lastDate){ dNum=i-(firstDay+lastDate)+1; cYear=(m===11?y+1:y); cMonth=(m===11?0:m+1); isEdge=true; }
      else { dNum=i-firstDay+1; cYear=y; cMonth=m; }

      const dow=i%7; if(dow===0) cell.classList.add('sun'); if(dow===6) cell.classList.add('sat');
      const dateEl=document.createElement('div'); dateEl.className='date'; dateEl.textContent=dNum;
      if(isEdge) cell.classList.add('edge'); cell.appendChild(dateEl);

      const k=keyOf(cYear,cMonth,dNum); cell.dataset.key=k;

      if(holidayMap[k]){
        const b=document.createElement('div'); b.className='holiday-badge'; b.textContent=holidayMap[k];
        cell.appendChild(b); cell.classList.add('holiday');
      }

      const val=sheetData[k];
      if(val){
        const t=document.createElement('div'); t.className='time'; t.textContent=val;
        if(val==='7ì‹œ'||val==='8ì‹œ') t.classList.add('sevenEight');
        else if(val==='12ì‹œ') t.classList.add('noon');
        else if(val==='íœ´ë¬´') t.classList.add('off');
        else if(['ì—°ì°¨','ë³‘ê°€','ê³µê°€','ì¶œì¥','ëŒë´„'].includes(val)) t.classList.add('special');
        else if(['ì‚¬ê°€ë…ì„œ','ì²´ë ¨ëŒ€íšŒ'].includes(val)) t.classList.add('special_small');
        if(isEdge) t.style.opacity=.55; cell.appendChild(t);
      }

      if(!isEdge && today.getFullYear()===cYear && today.getMonth()===cMonth && today.getDate()===dNum){
        cell.classList.add('today');
      }

      cell.addEventListener('click',()=>openModal(k,val||'')); grid.appendChild(cell);
    }
  }

  /* ===== ë Œë”: ìºì‹œ ì¦‰ì‹œ ì‚¬ìš© + ë¹„ë™ê¸° ê°±ì‹  ===== */
  async function render(){
    const { y:py, m:pm }=ymAdd(state.year,state.month,-1);
    const { y:ny, m:nm }=ymAdd(state.year,state.month, 1);
    const c1 = holiRead(`${py}-${pad(pm+1)}`) || {};
    const c2 = holiRead(`${state.year}-${pad(state.month+1)}`) || {};
    const c3 = holiRead(`${ny}-${pad(nm+1)}`) || {};
    holidayMap = Object.assign({}, c1, c2, c3);
    drawCalendar();

    try{
      const [prevMap,currMap,nextMap]=await Promise.all([
        fetchHolidays(py,pm), fetchHolidays(state.year,state.month), fetchHolidays(ny,nm)
      ]);
      const newMap = Object.assign({}, prevMap, currMap, nextMap);
      const changed = JSON.stringify(newMap) !== JSON.stringify(holidayMap);
      holidayMap = newMap;
      if (changed) drawCalendar();
    }catch(e){}
  }

  /* ===== ëª¨ë‹¬ ===== */
  function openModal(key,value){selectedKey=key;modalDate.textContent=key+' ì¶œê·¼/ìƒíƒœ';timeSelect.value=value||'';modal.classList.add('show');}
  function closeModal(){modal.classList.remove('show');}
  saveBtn.addEventListener('click',async()=>{if(!selectedKey)return;await saveToSheet(selectedKey,timeSelect.value);sheetData[selectedKey]=timeSelect.value;drawCalendar();closeModal();});
  clearBtn.addEventListener('click',async()=>{if(!selectedKey)return;await deleteFromSheet(selectedKey);delete sheetData[selectedKey];drawCalendar();closeModal();});
  cancelBtn.addEventListener('click',closeModal);
  modal.addEventListener('click',e=>{if(e.target===modal)closeModal();});

  /* ===== ë‚´ë¹„ ë²„íŠ¼ ===== */
  prevBtn.addEventListener('click',()=>{state.month--;if(state.month<0){state.month=11;state.year--;}localStorage.setItem('lastView', JSON.stringify(state));render();});
  nextBtn.addEventListener('click',()=>{state.month++;if(state.month>11){state.month=0;state.year++;}localStorage.setItem('lastView', JSON.stringify(state));render();});
  sheetLoadBtn.addEventListener('click',async()=>{await reloadFromSheet();drawCalendar();alert('ë¶ˆëŸ¬ì˜¤ê¸° ì„±ê³µ');});

  /* ===== ìŠ¤ì™€ì´í”„(ë³µì›) ===== */
  let touchStartX=0,touchEndX=0,touchStartY=0,touchEndY=0;
  const SWIPE_THRESHOLD=50, VERTICAL_TOLERANCE=40;
  grid.addEventListener('touchstart', e=>{
    touchStartX=e.changedTouches[0].screenX;
    touchStartY=e.changedTouches[0].screenY;
  },{passive:true});
  grid.addEventListener('touchend', e=>{
    touchEndX=e.changedTouches[0].screenX;
    touchEndY=e.changedTouches[0].screenY;
    const dx=touchEndX-touchStartX, dy=touchEndY-touchStartY;
    if(Math.abs(dx)>SWIPE_THRESHOLD && Math.abs(dy)<VERTICAL_TOLERANCE){
      if(dx<0){ state.month++; if(state.month>11){state.month=0;state.year++;} }
      else { state.month--; if(state.month<0){state.month=11;state.year--;} }
      localStorage.setItem('lastView', JSON.stringify(state));
      render();
    }
  },{passive:true});

  /* ====== ğŸ‘‡ ì¶”ê°€: êµ¬ê¸€ì‹œíŠ¸ ìë™ í´ë§(ë²„íŠ¼ ì—†ì´ ìµœì‹  ë°˜ì˜) ====== */
  const AUTO_REFRESH_MS = 15000; // 15ì´ˆ(ì›í•˜ë©´ 10~30ì´ˆë¡œ ì¡°ì ˆ)
  let _pollTimer = null;
  let _lastDataHash = null;

  function hashString(s){
    let h=5381; for(let i=0;i<s.length;i++){ h=((h<<5)+h)+s.charCodeAt(i); }
    return (h>>>0).toString(36);
  }
  function hashData(obj){
    try { return hashString(JSON.stringify(obj)); } catch(e){ return ''; }
  }

  async function checkForUpdatesOnce(){
    if (modal.classList.contains('show')) return; // í¸ì§‘ ì¤‘ì´ë©´ ì¶©ëŒ ë°©ì§€
    try{
      const res = await fetchWithTimeout(WEBAPP_URL+'?_='+Date.now(), 6000);
      const j = await res.json();
      if(!(j && j.ok)) return;
      const newHash = hashData(j.data||{});
      if (newHash !== _lastDataHash){
        _lastDataHash = newHash;
        sheetData = j.data || {};
        drawCalendar(); // ë³€ê²½ì‚¬í•­ë§Œ ë°˜ì˜
      }
    }catch(e){ /* ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ëŠ” ë‹¤ìŒ ì£¼ê¸°ì— ì¬ì‹œë„ */ }
  }

  function startAutoRefresh(){
    stopAutoRefresh();
    _pollTimer = setInterval(checkForUpdatesOnce, AUTO_REFRESH_MS);
  }
  function stopAutoRefresh(){
    if(_pollTimer){ clearInterval(_pollTimer); _pollTimer=null; }
  }

  // íƒ­ì´ ë³´ì¼ ë•Œë§Œ í´ë§, ìˆ¨ê²¨ì§€ë©´ ì¤‘ë‹¨
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') startAutoRefresh();
    else stopAutoRefresh();
  });

  /* ===== ì´ˆê¸°í™” ===== */
  (async()=>{
    await reloadFromSheet();
    render();
    _lastDataHash = hashData(sheetData); // ì´ˆê¸° í•´ì‹œ ì €ì¥
    startAutoRefresh();                  // í´ë§ ì‹œì‘
  })();
</script>
</body>
</html>