<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>출근캘린더</title>
<style>
  :root{ --primary:#16a34a; --red:#e11d48; --blue:#2563eb; --text:#222; --sub:#6b7280; --border:#dfe3e8; --bg:#f8fafc; --card:#fff; }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Apple SD Gothic Neo','Noto Sans KR',sans-serif;color:var(--text)}
  .wrap{max-width:740px;margin:0 auto;padding:12px}

  /* ⬇ 캡처 대상 : 타이틀+요일+그리드 */
  #calendarCapture{background:#fff;border:2px solid var(--border);border-radius:12px;overflow:hidden;box-shadow:0 4px 10px rgba(0,0,0,.04)}
  .topbar{display:flex;align-items:center;justify-content:center;padding:12px 16px;border-bottom:1px solid var(--border);gap:8px;background:#fff}
  .title{font-weight:800;font-size:20px;letter-spacing:.5px}

  .weekday{display:grid;grid-template-columns:repeat(7,1fr);background:#f3f4f6;border-bottom:1px solid var(--border)}
  .weekday div{padding:10px 0;text-align:center;font-weight:700;color:var(--sub)}
  .weekday div:first-child{color:var(--red)} .weekday div:last-child{color:var(--blue)}

  .grid{display:grid;grid-template-columns:repeat(7,1fr);border-top:1px solid var(--border);touch-action:pan-y}
  .cell{height:72px;padding:22px 8px 6px;position:relative;background:#fff;overflow:hidden;border-right:1px solid var(--border);border-bottom:1px solid var(--border)}
  .grid .cell:nth-child(7n){border-right:1px solid var(--border)} /* 마지막 열도 선 유지 */

  .date{position:absolute;left:8px;top:6px;font-weight:800;line-height:1;z-index:1}
  .sun .date{color:var(--red)} .sat .date{color:var(--blue)}
  .edge .date{color:#c7cdd7} .edge .time{opacity:.55}
  .today{background:#f5f5f5} .today .date{color:#000;font-weight:800;text-decoration:underline;text-decoration-thickness:1px;text-underline-offset:3px}

  .time{position:absolute;bottom:0;left:0;width:100%;height:22px;line-height:22px;text-align:center;font-size:13px;font-weight:700}
  .time.sevenEight{background:#E5E5E5;color:#000} .time.noon{background:#8ECAE6;color:#000}
  .time.off{background:#FFB703;color:#000} .time.special{background:#219EBC;color:#000}
  .time.special_small{font-size:12px;background:#219EBC;color:#000}
</style>
</head>
<body>
  <div class="wrap">
    <div id="calendarCapture">
      <div class="topbar"><div class="title"><span id="monthTitle">YYYY. MM.</span></div></div>
      <div class="weekday"><div>일</div><div>월</div><div>화</div><div>수</div><div>목</div><div>금</div><div>토</div></div>
      <div class="grid" id="grid"></div>
    </div>
  </div>

<script>
  // === 설정 ===
  const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbwA1CtxLfbziu52wTUa-R4TKrN4NQajVtFKDVwYBFhGalUPU3QcHbK24mueAMkI8DLM/exec';

  // === 엘리먼트 ===
  const grid = document.getElementById('grid');
  const monthTitle = document.getElementById('monthTitle');

  // === 상태/유틸 ===
  let state = (()=>{try{const s=localStorage.getItem('lastView');if(s){const o=JSON.parse(s);if(o.year&&o.month>=0)return o;}}catch(e){};const n=new Date();return{year:n.getFullYear(),month:n.getMonth()};})();
  let sheetData = {};
  const pad = n => n.toString().padStart(2,'0');
  const keyOf = (y,m,d)=>`${y}-${pad(m+1)}-${pad(d)}`;
  const fetchWithTimeout=(u,ms,i={})=>{const c=new AbortController();const t=setTimeout(()=>c.abort('timeout'),ms);return fetch(u,{...i,signal:c.signal}).finally(()=>clearTimeout(t));};

  async function reloadFromSheet(){
    try{
      const r = await fetchWithTimeout(WEBAPP_URL+'?_='+(Date.now()), 6000);
      const j = await r.json();
      if(j && j.ok) sheetData = j.data || {};
    }catch(e){ sheetData = {}; }
  }

  function drawCalendar(){
    const y=state.year,m=state.month;
    monthTitle.textContent=`${y}. ${pad(m+1)}.`;

    const firstDay=new Date(y,m,1).getDay();
    const lastDate=new Date(y,m+1,0).getDate();
    const prevLast=new Date(y,m,0).getDate();
    const totalCells=Math.ceil((firstDay+lastDate)/7)*7;

    grid.innerHTML='';
    const today=new Date();

    for(let i=0;i<totalCells;i++){
      const cell=document.createElement('div');cell.className='cell';
      let dNum,cYear,cMonth,isEdge=false;
      if(i<firstDay){ dNum=prevLast-firstDay+i+1; cYear=(m===0?y-1:y); cMonth=(m===0?11:m-1); isEdge=true; }
      else if(i>=firstDay+lastDate){ dNum=i-(firstDay+lastDate)+1; cYear=(m===11?y+1:y); cMonth=(m===11?0:m+1); isEdge=true; }
      else { dNum=i-firstDay+1; cYear=y; cMonth=m; }

      const dow=i%7; if(dow===0) cell.classList.add('sun'); if(dow===6) cell.classList.add('sat');
      const dateEl=document.createElement('div'); dateEl.className='date'; dateEl.textContent=dNum;
      if(isEdge) cell.classList.add('edge'); cell.appendChild(dateEl);

      const k=keyOf(cYear,cMonth,dNum);
      const val=sheetData[k];
      if(val){
        const t=document.createElement('div'); t.className='time'; t.textContent=val;
        if(val==='7시'||val==='8시') t.classList.add('sevenEight');
        else if(val==='12시') t.classList.add('noon');
        else if(val==='휴무') t.classList.add('off');
        else if(['연차','병가','공가','출장','돌봄'].includes(val)) t.classList.add('special');
        else if(['사가독서','체련대회'].includes(val)) t.classList.add('special_small');
        if(isEdge) t.style.opacity=.55; cell.appendChild(t);
      }

      if(!isEdge && today.getFullYear()===cYear && today.getMonth()===cMonth && today.getDate()===dNum){
        cell.classList.add('today');
      }

      grid.appendChild(cell);
    }
  }

  (async()=>{
    await reloadFromSheet();
    drawCalendar();
    document.body.setAttribute('data-ready','1'); // 👈 캡처 스크립트가 이 신호를 기다림
  })();
</script>
</body>
</html>
